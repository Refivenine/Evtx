<!DOCTYPE html>
<html>
<head>
    <title>EVTX | Network</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#bf00ff">
    <link rel="apple-touch-icon" href="https://refivenine.github.io/Evtx/logo.png">

    <style>
        /* --- DESIGN ENGINE --- */
        body {
            background: linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.98)), url('https://refivenine.github.io/cover2.jpg');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; padding-bottom: 80px;
        }

        /* ICONS */
        .icon { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .icon-fill { fill: currentColor; }
        
        /* LAYOUT */
        .hidden { display: none !important; }
        .btn { border: none; outline: none; cursor: pointer; background: none; }

        /* AUTH SCREEN */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: #000; z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .auth-box {
            background: #151515; padding: 30px; border-radius: 20px;
            border: 1px solid #bf00ff; width: 85%; max-width: 350px; text-align: center;
        }
        .auth-input {
            width: 100%; padding: 12px; margin: 10px 0; background: #000;
            border: 1px solid #333; color: #fff; border-radius: 8px; box-sizing: border-box;
        }
        .main-btn {
            width: 100%; padding: 12px; background: #bf00ff; color: #fff;
            border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; border: none;
        }

        /* APP HEADER */
        .header {
            background: rgba(15, 15, 15, 0.95); padding: 15px; border-bottom: 1px solid #333;
            position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(10px);
        }
        .logo { font-weight: 900; color: #fff; font-size: 22px; letter-spacing: 1px; }
        .logo span { color: #bf00ff; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* POSTS */
        .create-box { background: #151515; padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 25px; }
        textarea { width: 100%; background: #080808; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 10px; resize: none; box-sizing: border-box; outline: none; }
        textarea:focus { border-color: #bf00ff; }

        .post { background: #151515; border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid #222; }
        .user-header { display: flex; align-items: center; margin-bottom: 12px; }
        .avatar {
            width: 42px; height: 42px; background: #333; border-radius: 50%; margin-right: 12px;
            border: 2px solid #333; background-size: cover; background-position: center;
            display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer;
        }
        .user-meta h4 { margin: 0; color: #fff; font-size: 15px; cursor: pointer; }
        .user-meta span { font-size: 12px; color: #777; }
        .content { font-size: 15px; line-height: 1.5; color: #ddd; margin-bottom: 10px; white-space: pre-wrap; }
        .post-img { width: 100%; border-radius: 12px; margin-top: 5px; border: 1px solid #333; }
        
        /* NEW ACTION BAR */
        .actions { 
            border-top: 1px solid #222; padding-top: 12px; margin-top: 10px; 
            display: flex; justify-content: space-between; padding-right: 20px;
        }
        .act-btn { 
            background: none; color: #777; font-size: 13px; display: flex; align-items: center; gap: 6px; 
            transition: 0.2s;
        }
        .act-btn:hover { color: #bf00ff; }
        .act-btn.liked { color: #e0245e; } /* Red heart when liked */
        .act-btn.liked svg { fill: #e0245e; stroke: none; }

        /* COMMENT OVERLAY */
        #comment-overlay {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70vh;
            background: #101010; border-top-left-radius: 20px; border-top-right-radius: 20px;
            z-index: 2500; border-top: 1px solid #bf00ff; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        #comment-overlay.open { transform: translateY(0); }
        .comment-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .comment-list { flex: 1; overflow-y: auto; padding: 15px; }
        .comment-input-box { padding: 15px; background: #1a1a1a; display: flex; gap: 10px; }
        .single-comment { margin-bottom: 15px; font-size: 14px; }
        .comment-user { color: #bf00ff; font-weight: bold; font-size: 12px; }

        /* SEARCH & PROFILE STYLES */
        .search-bar { width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 30px; outline: none; box-sizing: border-box; }
        .user-result { display: flex; align-items: center; background: #1a1a1a; padding: 10px; border-radius: 15px; margin-top: 10px; cursor: pointer; }
        .profile-header { text-align: center; background: #151515; padding: 30px; border-radius: 20px; border: 1px solid #333; margin-bottom: 20px; }
        .big-avatar { width: 100px; height: 100px; margin: 0 auto 15px; border-radius: 50%; border: 3px solid #bf00ff; background-size: cover; background-position: center; background-color: #333; }
        .form-input { width: 100%; background: #080808; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px;}

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #000; border-top: 1px solid #222;
            display: flex; justify-content: space-around; padding: 12px 0; z-index: 2000;
        }
        .nav-item { color: #555; font-size: 24px; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .nav-item span { font-size: 10px; margin-top: 4px; }
        .nav-active { color: #bf00ff; }

    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="logo" style="margin-bottom: 20px; font-size: 40px;">EV<span>TX</span></div>
        <div class="auth-box">
            <h2 id="auth-title" style="color:#fff;">Login</h2>
            <input type="email" id="email" class="auth-input" placeholder="Email">
            <input type="password" id="password" class="auth-input" placeholder="Password">
            <button id="auth-action-btn" class="main-btn">Enter Network</button>
            <p id="toggle-auth-btn" style="color:#777; font-size:14px; text-decoration:underline; cursor:pointer;">New here? Create Account</p>
            <div id="auth-msg" style="color: #ff3333; margin-top: 10px; font-size: 13px;"></div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        
        <div class="header">
            <div class="logo">EV<span>TX</span></div>
            <button onclick="logout()" class="btn" style="color:#777; font-size:12px;">Log Out</button>
        </div>

        <div class="container">
            <div id="tab-home" class="tab-content active-tab">
                <div class="create-box">
                    <textarea id="postInput" rows="2" placeholder="What is happening?"></textarea>
                    <div id="filePreview" style="color: #bf00ff; font-size: 12px; margin: 5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <label for="fileInput" style="cursor:pointer; color:#bf00ff;">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </label>
                        <input type="file" id="fileInput" accept="image/*" hidden>
                        <button id="sendBtn" class="main-btn" style="width:auto; margin:0; padding:8px 20px;">Post</button>
                    </div>
                </div>
                <div id="feed">Loading...</div>
            </div>

            <div id="tab-search" class="tab-content hidden">
                <input type="text" id="searchInput" class="search-bar" placeholder="ðŸ” Search users...">
                <div id="searchResults"></div>
            </div>

            <div id="tab-profile" class="tab-content hidden">
                <div class="profile-header">
                    <div id="my-pic" class="big-avatar"></div>
                    <button onclick="document.getElementById('profilePicInput').click()" class="btn" style="color:#bf00ff; font-size:12px; margin-bottom:15px;">Change Photo</button>
                    <input type="file" id="profilePicInput" hidden>
                    <input type="text" id="p-name" class="form-input" placeholder="Name">
                    <input type="text" id="p-bio" class="form-input" placeholder="Bio">
                    <input type="text" id="p-country" class="form-input" placeholder="Country">
                    <button id="saveProfileBtn" class="main-btn">Save Profile</button>
                </div>
            </div>
        </div>

        <div id="comment-overlay">
            <div class="comment-header">
                <span style="font-weight:bold;">Comments</span>
                <button onclick="closeComments()" class="btn" style="color:#fff;">âœ•</button>
            </div>
            <div id="comment-list" class="comment-list"></div>
            <div class="comment-input-box">
                <input type="text" id="comment-input" class="auth-input" style="margin:0;" placeholder="Add a comment...">
                <button id="submit-comment-btn" class="main-btn" style="width:auto; margin:0;">Send</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item nav-active" onclick="switchTab('home')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            </div>
            <div class="nav-item" onclick="switchTab('search')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <div class="nav-item" onclick="switchTab('profile')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, where, onSnapshot, serverTimestamp, updateDoc, doc, increment, deleteDoc, setDoc, getDoc, getDocs } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- CONFIG ---
        const ADMIN_EMAIL = "hrangategamer@gmail.com"; // CHECK THIS!
        
        const firebaseConfig = {
          apiKey: "AIzaSyAiaKBfUC4QScczQq6wARW7KC0-gKcomg8",
          authDomain: "evtx-social.firebaseapp.com",
          projectId: "evtx-social",
          storageBucket: "evtx-social.firebasestorage.app",
          messagingSenderId: "24242683037",
          appId: "1:24242683037:web:48dcc74fe3d241cfb76874"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const postsRef = collection(db, "posts");

        let currentUser = null;
        let currentPostIdForComments = null;

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById("auth-screen").classList.add("hidden");
                document.getElementById("app-screen").classList.remove("hidden");
                loadFeed();
                
                // Load Profile
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if(uDoc.exists()) {
                    const d = uDoc.data();
                    document.getElementById('p-name').value = d.name || "";
                    document.getElementById('p-bio').value = d.bio || "";
                    document.getElementById('p-country').value = d.country || "";
                    if(d.pic) document.getElementById('my-pic').style.backgroundImage = `url('${d.pic}')`;
                }
            } else {
                document.getElementById("auth-screen").classList.remove("hidden");
                document.getElementById("app-screen").classList.add("hidden");
            }
        });

        // FEED
        function loadFeed() {
            onSnapshot(query(postsRef, orderBy("createdAt", "desc")), (snapshot) => {
                const feed = document.getElementById("feed");
                feed.innerHTML = "";
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const el = document.createElement("div");
                    el.className = "post";
                    
                    const isAdmin = p.userEmail === ADMIN_EMAIL;
                    const badge = isAdmin ? `<span style="color:#ffd700; margin-left:4px;">ðŸ‘‘</span>` : "";
                    
                    // Avatar
                    let avatarStyle = "";
                    let avatarTxt = "";
                    if(isAdmin) avatarStyle = "background-image:url('https://refivenine.github.io/Evtx/logo.png'); border-color:#ffd700;";
                    else if(p.userPic) avatarStyle = `background-image:url('${p.userPic}');`;
                    else avatarTxt = (p.username||"?").charAt(0).toUpperCase();

                    // ICONS: Heart, Chat, Share, Trash
                    const heartIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>`;
                    const chatIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>`;
                    const shareIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>`;
                    const trashIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;

                    el.innerHTML = `
                        <div class="user-header">
                            <div class="avatar" style="${avatarStyle}">${avatarTxt}</div>
                            <div class="user-meta">
                                <h4>${p.username} ${badge}</h4>
                                <span>${p.userBio || "Member"}</span>
                            </div>
                            ${currentUser.email === ADMIN_EMAIL ? `<button class="act-btn" onclick="delPost('${doc.id}')" style="margin-left:auto; color:#cc0000;">${trashIcon}</button>` : ""}
                        </div>
                        <div class="content">${p.text}</div>
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="post-img">` : ""}
                        <div class="actions">
                            <button class="act-btn" onclick="likePost('${doc.id}')">${heartIcon} <span>${p.likes||0}</span></button>
                            <button class="act-btn" onclick="openComments('${doc.id}')">${chatIcon} <span>Comment</span></button>
                            <button class="act-btn" onclick="sharePost('${p.username}', '${p.text}')">${shareIcon} <span>Share</span></button>
                        </div>
                    `;
                    feed.appendChild(el);
                });
            });
        }

        // GLOBAL ACTIONS
        window.likePost = (id) => updateDoc(doc(db,"posts",id), {likes: increment(1)});
        window.delPost = (id) => { if(confirm("Delete?")) deleteDoc(doc(db,"posts",id)); };
        
        window.sharePost = async (user, text) => {
            if (navigator.share) {
                try { await navigator.share({ title: `Post by ${user}`, text: text, url: window.location.href }); } 
                catch (err) { console.log("Share failed", err); }
            } else { alert("Link copied!"); }
        };

        // COMMENTS LOGIC
        window.openComments = (postId) => {
            currentPostIdForComments = postId;
            document.getElementById("comment-overlay").classList.add("open");
            const list = document.getElementById("comment-list");
            list.innerHTML = "Loading...";

            onSnapshot(collection(db, "posts", postId, "comments"), (snap) => {
                list.innerHTML = "";
                if(snap.empty) list.innerHTML = "<div style='text-align:center; color:#555; margin-top:20px;'>No comments yet.</div>";
                snap.forEach(d => {
                    const c = d.data();
                    const item = document.createElement("div");
                    item.className = "single-comment";
                    item.innerHTML = `<span class="comment-user">${c.username}:</span> <span style="color:#ddd;">${c.text}</span>`;
                    list.appendChild(item);
                });
            });
        };

        window.closeComments = () => document.getElementById("comment-overlay").classList.remove("open");

        document.getElementById("submit-comment-btn").addEventListener("click", async () => {
            const txt = document.getElementById("comment-input").value;
            if(!txt || !currentPostIdForComments) return;
            
            // Get user name
            let name = "User";
            const uDoc = await getDoc(doc(db, "users", currentUser.uid));
            if(uDoc.exists()) name = uDoc.data().name || currentUser.email.split('@')[0];

            await addDoc(collection(db, "posts", currentPostIdForComments, "comments"), {
                text: txt,
                username: name,
                createdAt: serverTimestamp()
            });
            document.getElementById("comment-input").value = "";
        });

        // POSTING & NAV
        document.getElementById("sendBtn").addEventListener("click", async () => {
            const input = document.getElementById("postInput");
            const file = document.getElementById("fileInput").files[0];
            if(!input.value && !file) return;

            document.getElementById("sendBtn").innerText = "...";
            let url = null;
            if(file) url = await compressImage(file);

            // Get Profile Data
            let name = currentUser.email.split('@')[0];
            let pic = null;
            let bio = "Member";
            const uDoc = await getDoc(doc(db, "users", currentUser.uid));
            if(uDoc.exists()) {
                const d = uDoc.data();
                name = d.name || name;
                pic = d.pic;
                bio = d.hobby ? d.hobby : bio;
            }

            await addDoc(postsRef, {
                text: input.value, imageUrl: url,
                userEmail: currentUser.email, uid: currentUser.uid,
                username: name, userPic: pic, userBio: bio,
                createdAt: serverTimestamp(), likes: 0
            });

            input.value = ""; document.getElementById("fileInput").value = "";
            document.getElementById("sendBtn").innerText = "Post";
        });

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 800/img.width; canvas.width=800; canvas.height=img.height*scale;
                        canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
                        resolve(canvas.toDataURL('image/jpeg',0.7));
                    }
                }
            });
        };

        window.switchTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
        };
        window.logout = () => signOut(auth);

        // LOGIN HANDLERS
        document.getElementById("auth-action-btn").addEventListener("click", () => {
             const e = document.getElementById("email").value;
             const p = document.getElementById("password").value;
             const isSignup = document.getElementById("auth-action-btn").innerText.includes("Enter") === false;
             if(isSignup) createUserWithEmailAndPassword(auth, e, p).catch(err=>alert(err.message));
             else signInWithEmailAndPassword(auth, e, p).catch(err=>alert(err.message));
        });
        document.getElementById("toggle-auth-btn").addEventListener("click", function() {
            const isSignup = this.innerText.includes("Create");
            this.innerText = isSignup ? "Have an account? Login" : "New here? Create Account";
            document.getElementById("auth-action-btn").innerText = isSignup ? "Sign Up" : "Enter Network";
        });
        
        // SAVE PROFILE
        document.getElementById("saveProfileBtn").addEventListener("click", async () => {
            const btn = document.getElementById("saveProfileBtn"); btn.innerText = "Saving...";
            const file = document.getElementById("profilePicInput").files[0];
            let url = null;
            if(file) url = await compressImage(file);
            
            const data = { name: document.getElementById('p-name').value, bio: document.getElementById('p-bio').value, country: document.getElementById('p-country').value };
            if(url) data.pic = url;
            
            await setDoc(doc(db,"users",currentUser.uid), data, {merge:true});
            if(url) document.getElementById('my-pic').style.backgroundImage = `url('${url}')`;
            btn.innerText = "Saved"; setTimeout(()=>btn.innerText="Save Profile", 2000);
        });

    </script>
</body>
</html>
