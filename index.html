<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EVTX | Pro Network</title>
    <style>
        /* --- 1. CORE VARIABLES --- */
        :root { --app-color: #bf00ff; }
        
        /* --- 2. THE "COOL" BODY (Space Gradient) --- */
        body {
            /* Deep Space Gradient Background */
            background: radial-gradient(circle at top left, #1a0b2e, #000000);
            background-attachment: fixed; /* Keeps bg still while scrolling */
            color: #e0e0e0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; padding-bottom: 80px;
            /* Mesh Pattern Overlay */
            background-image: 
                radial-gradient(at 0% 0%, hsla(280,100%,20%,0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(320,100%,20%,0.3) 0px, transparent 50%);
        }

        .hidden { display: none !important; }
        .icon { width: 24px; height: 24px; fill: currentColor; }

        /* --- 3. THE "GLASS" CARDS (Pro Look) --- */
        /* This replaces the boring gray boxes with Frosted Glass */
        .post, .create-box, .profile-container, .auth-box, .news-card {
            background: rgba(22, 22, 22, 0.7) !important; /* Semi-transparent */
            backdrop-filter: blur(12px) !important;       /* The Blur Magic */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3) !important;
            border-radius: 24px !important;
            padding: 15px;
            margin: 15px;
            margin-bottom: 20px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* Hover Effect */
        .post:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px 0 rgba(191, 0, 255, 0.15) !important;
            border-color: rgba(191, 0, 255, 0.3) !important;
        }

        /* --- 4. THE "JELLY" BUTTONS (Cute Look) --- */
        .btn, .main-btn, .friend-btn {
            border-radius: 50px !important; /* Pill Shape */
            font-weight: 800 !important;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 11px !important;
            border: none !important;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important; /* Bouncy */
            padding: 10px 20px;
        }

        /* Purple Gradient Button */
        .main-btn, .btn {
            background: linear-gradient(135deg, #bf00ff, #ff00cc) !important;
            color: white;
            box-shadow: 0 4px 15px rgba(191, 0, 255, 0.4);
        }

        /* Button Interactions */
        .main-btn:hover, .btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 25px rgba(191, 0, 255, 0.6); }
        .main-btn:active, .btn:active { transform: scale(0.90) !important; }

        /* Secondary/Gray Buttons */
        .act-btn, .vid-btn {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 8px 12px;
            color: #aaa;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 5px; cursor: pointer;
            transition: 0.2s;
        }
        .act-btn:active { transform: scale(0.9); }
        .act-btn.liked { color: #ff0055; background: rgba(255,0,85,0.1); border-color: #ff0055; }

        /* --- 5. LAYOUT UTILITIES --- */
        .header { display: flex; justify-content: space-between; padding: 15px; align-items: center; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); background: rgba(0,0,0,0.5); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { font-size: 24px; font-weight: 900; letter-spacing: 1px; } .logo span { color: var(--app-color); }
        .container { max-width: 600px; margin: 0 auto; }
        
        .user-header { display: flex; align-items: center; margin-bottom: 12px; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background-size: cover; background-position: center; border: 2px solid rgba(255,255,255,0.1); margin-right: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .user-meta h4 { margin: 0; font-size: 15px; color: #fff; }
        .user-meta span { font-size: 12px; color: #888; }
        
        .content { margin-bottom: 12px; line-height: 1.5; font-size: 15px; color: #eee; white-space: pre-wrap; }
        .post-img, .post-video-frame { width: 100%; border-radius: 16px; margin-top: 8px; border: 1px solid rgba(255,255,255,0.1); }
        
        .actions { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.08); }
        
        textarea { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 15px; border-radius: 15px; resize: none; outline: none; box-sizing: border-box; font-family: inherit; font-size: 16px; margin-bottom: 10px; }
        input { width: 100%; padding: 12px; margin: 5px 0; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; box-sizing: border-box; }

        /* NAV BAR */
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(30,30,30,0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; display: flex; justify-content: space-around; padding: 15px 0; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .nav-item { color: #888; font-size: 22px; cursor: pointer; transition: 0.2s; position: relative; }
        .nav-item.active { color: var(--app-color); transform: translateY(-3px); }
        
        /* AUTH SCREEN */
        #auth-screen { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; background-image: radial-gradient(circle at center, #1a0b2e, #000); }
        
        /* SPLASH SCREEN */
        #splash-screen { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .pulse-logo { font-size: 60px; font-weight: 900; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="pulse-logo" style="color:#fff;">EV<span style="color:#bf00ff;">TX</span></div>
        <div style="color:#666; font-size:12px; letter-spacing:2px; margin-top:20px;">SYSTEM INITIALIZING...</div>
    </div>

    <div id="auth-screen" class="hidden">
        <div class="logo" style="font-size:50px; margin-bottom:30px;">EV<span>TX</span></div>
        <div class="auth-box" style="width:300px; text-align:center;">
            <h2 style="color:white; margin-top:0;">Welcome</h2>
            <button onclick="signInGoogle()" class="main-btn" style="width:100%; font-size:14px;">üöÄ Login with Google</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="header">
            <div class="logo">EV<span>TX</span></div>
            <button onclick="logout()" class="act-btn">Log Out</button>
        </div>

        <div class="container">
            <div class="create-box">
                <textarea id="postInput" rows="2" placeholder="What's on your mind?"></textarea>
                <div id="mediaPreview" style="margin-bottom:10px;"></div>
                
                <div class="time-capsule-wrapper" style="background:rgba(191,0,255,0.1); padding:10px; border-radius:12px; margin-bottom:15px; border:1px dashed #bf00ff; display:flex; align-items:center; gap:10px;">
                    <span style="font-size:20px;">üîí</span>
                    <div>
                        <label style="color:#bf00ff; font-size:12px; font-weight:bold; display:block;">Time Capsule (Optional)</label>
                        <input type="datetime-local" id="capsule-date" style="border:none; background:transparent; color:#fff; padding:0; font-size:12px;">
                    </div>
                </div>

                <div style="display:flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex; gap:10px;">
                        <label for="fileInput" class="vid-btn">üñºÔ∏è Media</label>
                        <input type="file" id="fileInput" accept="image/*,video/*" hidden>
                    </div>
                    <button id="postBtn" class="main-btn">Post Update</button>
                </div>
            </div>

            <div id="feed" style="padding-bottom: 100px;">Loading feed...</div>
        </div>

        <div class="nav-bar">
            <div class="nav-item active">üè†</div>
            <div class="nav-item">üåç</div>
            <div class="nav-item">üí¨</div>
            <div class="nav-item">üîî</div>
            <div class="nav-item">üë§</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        // --- YOUR CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAiaKBFUc4QScczQq6wARW7KC0-gkcomg8",
            authDomain: "evtx-social.firebaseapp.com",
            projectId: "evtx-social",
            storageBucket: "evtx-social.firebasestorage.app",
            messagingSenderId: "24242683037",
            appId: "1:24242683037:web:48dcc74fe3d241cfb76874"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const postsRef = collection(db, "posts");
        const ADMIN_EMAIL = "refivenine@gmail.com"; 

        let currentUser = null;
        let currentUserName = "User";
        let finalPostImage = null;

        const provider = new GoogleAuthProvider();
        window.signInGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            const splash = document.getElementById("splash-screen");
            if (user) {
                currentUser = user;
                currentUserName = user.displayName;
                document.getElementById("auth-screen").classList.add("hidden");
                document.getElementById("app-screen").classList.remove("hidden");
                loadFeed();
            } else {
                document.getElementById("auth-screen").classList.remove("hidden");
                document.getElementById("app-screen").classList.add("hidden");
            }
            setTimeout(() => splash.classList.add("hidden"), 1500);
        });

        // --- MOCK UPLOAD (Replace with your Cloudinary if you have it) ---
        window.uploadToCloudinary = async (file) => {
             // FOR DEMO: This just creates a fake local URL so you can see it working immediately.
             // If you have real Cloudinary code, paste it here instead!
             return URL.createObjectURL(file);
        };

        // --- POSTING ---
        document.getElementById("postBtn").addEventListener("click", async () => {
            const btn = document.getElementById("postBtn");
            const text = document.getElementById("postInput").value;
            const dateInput = document.getElementById("capsule-date");
            
            if (!text && !finalPostImage) return;
            btn.innerText = "Posting...";
            
            try {
                const unlockDate = dateInput.value ? new Date(dateInput.value).getTime() : null;
                await addDoc(postsRef, {
                    text: text,
                    imageUrl: finalPostImage,
                    author: currentUser.uid,
                    username: currentUser.displayName,
                    userPic: currentUser.photoURL,
                    userEmail: currentUser.email,
                    timestamp: serverTimestamp(),
                    likes: [],
                    voiceNotes: [],
                    unlockAt: unlockDate
                });
                document.getElementById("postInput").value = "";
                document.getElementById("mediaPreview").innerHTML = "";
                if(dateInput) dateInput.value = ""; 
                finalPostImage = null;
                btn.innerText = "Post Update";
            } catch (err) {
                console.error(err);
                btn.innerText = "Error";
            }
        });

        // --- FEED LOADER ---
        function loadFeed() {
            const q = query(postsRef, orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const feed = document.getElementById("feed");
                feed.innerHTML = ""; 

                snapshot.forEach((docSnap) => {
                    const p = docSnap.data();
                    const id = docSnap.id;
                    const el = document.createElement("div");
                    el.className = "post";
                    el.id = `post-${id}`;

                    // TIME CAPSULE LOGIC
                    const now = new Date().getTime();
                    if (p.unlockAt && now < p.unlockAt) {
                         const timeToWait = p.unlockAt - now;
                         const unlockDateString = new Date(p.unlockAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                         el.innerHTML = `
                            <div class="user-header">
                                <div class="avatar" style="background-image:url('${p.userPic}')"></div>
                                <div class="user-meta"><h4>${p.username}</h4><span>Locked Post üîí</span></div>
                            </div>
                            <div id="lock-card-${id}" style="padding: 30px; text-align: center; border: 1px dashed #bf00ff; background: rgba(191, 0, 255, 0.05); border-radius: 10px;">
                                <div style="font-size: 40px; margin-bottom: 10px; animation:pulse 2s infinite;">üîí</div>
                                <h3 style="color: #bf00ff; margin: 0;">Time Capsule</h3>
                                <p style="color: #aaa; font-size: 12px;">Unlocks at <b style="color:white;">${unlockDateString}</b></p>
                            </div>
                        `;
                        // Auto-unlock timer
                        if (timeToWait > 0 && timeToWait < 2000000000) {
                            setTimeout(() => {
                                const card = document.getElementById(`lock-card-${id}`);
                                if(card) {
                                    card.innerHTML = `<h3 style="color:#00ff00;">üîì Unlocking...</h3>`;
                                    setTimeout(() => { el.innerHTML = getPostHTML(id, p); }, 1000);
                                }
                            }, timeToWait);
                        }
                    } else {
                        el.innerHTML = getPostHTML(id, p);
                    }
                    feed.appendChild(el);
                });
            });
        }

        function getPostHTML(id, p) {
            const isA = p.userEmail === ADMIN_EMAIL; 
            const b = isA ? `<span style="color:#ffd700; margin-left:4px;">üëë</span>` : "";
            let as = ""; 
            if(isA) as = "background-image:url('https://refivenine.github.io/Evtx/logo.png'); border-color:#ffd700;"; 
            else if(p.userPic) as = `background-image:url('${p.userPic}')`;
            
            let media = "";
            if (p.videoUrl) media = `<video src="${p.videoUrl}" controls class="post-video-frame"></video>`;
            else if (p.imageUrl) media = `<img src="${p.imageUrl}" class="post-img">`;

            // Voice Player
            let voiceHTML = "";
            if (p.voiceNotes && p.voiceNotes.length > 0) {
                voiceHTML = `<div style="margin-top:10px; padding:8px; background:rgba(0,0,0,0.3); border-radius:10px;">`;
                p.voiceNotes.forEach(note => {
                    voiceHTML += `
                        <div style="display:flex; align-items:center; margin-bottom:5px;">
                            <span style="font-size:10px; color:#bf00ff; margin-right:5px;">${note.name}:</span>
                            <audio controls src="${note.url}" style="height:25px; width:180px;"></audio>
                        </div>`;
                });
                voiceHTML += `</div>`;
            }

            const iL = p.likes && p.likes.includes(currentUser.uid); 
            const lc = iL ? "act-btn liked" : "act-btn";

            return `<div class="user-header"><div class="avatar" style="${as}"></div><div class="user-meta"><h4>${p.username} ${b}</h4><span>${new Date(p.timestamp?.toDate()).toLocaleDateString()}</span></div></div>
                    <div class="content">${p.text}</div>
                    ${media}
                    ${voiceHTML}
                    <div class="actions">
                        <button class="${lc}" onclick="likePost('${id}')">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <span>${p.likes ? p.likes.length : 0}</span>
                        </button>
                        <button class="act-btn">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </button>
                        <button onclick="toggleVoiceRecording('${id}')" class="act-btn" id="mic-btn-${id}">
                            üé§ <span id="mic-status-${id}" style="font-size:12px;">Voice</span>
                        </button>
                    </div>`;
        }

        // --- VOICE LOGIC ---
        let mediaRecorder; let audioChunks = []; let activeRecordingId = null;
        window.toggleVoiceRecording = async (postId) => {
            const btn = document.getElementById(`mic-btn-${postId}`);
            const status = document.getElementById(`mic-status-${postId}`);
            if (activeRecordingId === postId && mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                btn.style.color = ""; status.innerText = "Sending..."; activeRecordingId = null; return;
            }
            if (activeRecordingId) { alert("Already recording!"); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                activeRecordingId = postId;
                btn.style.color = "red"; status.innerText = "Recording...";
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    // Using the mock upload for now - Replace with Cloudinary if you have it
                    const audioUrl = URL.createObjectURL(audioBlob); 
                    
                    const postRef = doc(db, "posts", postId);
                    await updateDoc(postRef, {
                        voiceNotes: arrayUnion({ url: audioUrl, name: currentUserName, timestamp: Date.now() })
                    });
                    status.innerText = "Sent!"; setTimeout(() => status.innerText = "Voice", 2000);
                };
                mediaRecorder.start();
            } catch (err) { console.error(err); alert("Mic error!"); }
        };

        // --- LIKE LOGIC ---
        window.likePost = async (postId) => {
            if(!currentUser) return;
            const postRef = doc(db, "posts", postId);
            const pDoc = await getDoc(postRef);
            if(pDoc.exists()) {
                const likes = pDoc.data().likes || [];
                if(!likes.includes(currentUser.uid)) {
                    await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
                }
            }
        };

        // --- FILE INPUT ---
        document.getElementById("fileInput").addEventListener("change", async (e) => {
             const file = e.target.files[0];
             if(file) {
                 document.getElementById("mediaPreview").innerText = "Uploading media...";
                 finalPostImage = await uploadToCloudinary(file);
                 document.getElementById("mediaPreview").innerHTML = `<img src="${finalPostImage}" style="height:50px; border-radius:5px;">`;
             }
        });
    </script>
</body>
</html>
