<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EVTX - Next Gen Social</title>
    <style>
        :root { --app-color: #bf00ff; --bg-color: #000; --card-bg: #111; --text-color: #fff; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* SPLASH SCREEN */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .pulse-logo { font-size: 50px; font-weight: bold; animation: pulse 1.5s infinite; }
        .pulse-logo span { color: var(--app-color); }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }

        /* APP LAYOUT */
        .header { display: flex; justify-content: space-between; padding: 15px; align-items: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #333; }
        .logo { font-size: 24px; font-weight: bold; }
        .logo span { color: var(--app-color); }
        .container { max-width: 600px; margin: 0 auto; padding: 10px; padding-bottom: 80px; }

        /* POSTS */
        .post { background: var(--card-bg); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #222; }
        .user-header { display: flex; align-items: center; margin-bottom: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background-size: cover; background-position: center; border: 2px solid var(--app-color); margin-right: 10px; }
        .user-meta h4 { margin: 0; font-size: 14px; }
        .user-meta span { font-size: 12px; color: #777; }
        .content { margin-bottom: 10px; line-height: 1.4; font-size: 14px; white-space: pre-wrap; }
        .post-img { width: 100%; border-radius: 10px; margin-top: 5px; }
        .post-video-frame { width: 100%; border-radius: 10px; margin-top: 5px; }

        /* ACTIONS */
        .actions { display: flex; justify-content: space-around; margin-top: 15px; border-top: 1px solid #222; padding-top: 10px; }
        .act-btn { background: none; border: none; color: #777; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 14px; }
        .act-btn.liked { color: #bf00ff; }
        .icon { width: 20px; height: 20px; fill: currentColor; }
        .btn { background: var(--app-color); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* CREATE POST BOX */
        .create-box { background: var(--card-bg); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #333; }
        textarea { width: 100%; background: transparent; border: none; color: white; resize: none; outline: none; font-family: inherit; font-size: 16px; }
        
        /* AUTH SCREEN */
        #auth-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        .auth-box { width: 80%; max-width: 300px; }
        input { width: 100%; padding: 10px; margin: 5px 0; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }

        /* BOTTOM NAV */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: black; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 15px 0; z-index: 1000; }
        .nav-item { color: #777; font-size: 24px; cursor: pointer; }
        .nav-item.active { color: var(--app-color); }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="pulse-logo">EV<span>TX</span></div>
        <div style="color:#777; margin-top:10px; font-size:12px;">ESTABLISHING UPLINK...</div>
    </div>

    <div id="auth-screen" class="hidden">
        <div class="logo" style="margin-bottom: 20px; font-size: 40px;">EV<span>TX</span></div>
        <div class="auth-box">
            <h2 id="auth-title" style="color:#fff;">Sign In</h2>
            <button onclick="signInGoogle()" class="btn" style="width:100%; margin-top:10px;">Login with Google</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="header">
            <div class="logo">EV<span>TX</span></div>
            <button onclick="logout()" class="btn" style="color:#777; background:none; font-size:12px;">Log Out</button>
        </div>

        <div class="container">
            <div class="create-box">
                <textarea id="postInput" rows="2" placeholder="What is happening?"></textarea>
                <div id="mediaPreview" style="color: var(--app-color); font-size: 12px; margin: 5px 0;"></div>
                
                <div class="time-capsule-wrapper" style="margin-top: 10px; margin-bottom: 10px;">
                    <label style="color: #bf00ff; font-size: 0.9rem;">üîí Time Capsule (Optional):</label>
                    <input type="datetime-local" id="capsule-date" style="background: #333; color: white; border: 1px solid #bf00ff; padding: 5px; border-radius: 5px;">
                    <small style="display:block; color: gray; font-size: 0.7rem;">Friends can't see this content until this date.</small>
                </div>

                <div style="display:flex; justify-content: space-between; align-items: center; margin-top:10px;">
                    <div style="display:flex; gap:10px;">
                        <label for="fileInput" class="btn" style="background:#222; font-size:12px;">üñºÔ∏è Media</label>
                        <input type="file" id="fileInput" accept="image/*,video/*" hidden>
                    </div>
                    <button id="postBtn" class="btn">Post</button>
                </div>
            </div>

            <div id="feed">Loading feed...</div>
        </div>

        <div class="nav-bar">
            <div class="nav-item active">üè†</div>
            <div class="nav-item">üåç</div>
            <div class="nav-item">üí¨</div>
            <div class="nav-item">üîç</div>
            <div class="nav-item">üîî</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        // --- CONFIGURATION (Based on your Screenshots) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAiaKBFUc4QScczQq6wARW7KC0-gkcomg8",
            authDomain: "evtx-social.firebaseapp.com",
            projectId: "evtx-social",
            storageBucket: "evtx-social.firebasestorage.app",
            messagingSenderId: "YOUR_SENDER_ID", // If you have this, replace it. If not, it might still work.
            appId: "YOUR_APP_ID" // If you have this, replace it.
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const postsRef = collection(db, "posts");
        const ADMIN_EMAIL = "refivenine@gmail.com"; // Updated from your screenshot logic

        let currentUser = null;
        let currentUserName = "User";
        let finalPostImage = null; // Stores uploaded image URL

        // --- AUTHENTICATION ---
        const provider = new GoogleAuthProvider();
        window.signInGoogle = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            const splash = document.getElementById("splash-screen");
            if (user) {
                currentUser = user;
                currentUserName = user.displayName;
                document.getElementById("auth-screen").classList.add("hidden");
                document.getElementById("app-screen").classList.remove("hidden");
                loadFeed();
                
                // Get extended user details if needed
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if(uDoc.exists()) {
                   // Apply theme or custom settings here
                }
            } else {
                document.getElementById("auth-screen").classList.remove("hidden");
                document.getElementById("app-screen").classList.add("hidden");
            }
            setTimeout(() => splash.classList.add("hidden"), 1000); // Hide splash
        });

        // --- UPLOAD MOCK FUNCTION (Replace if you have the real Cloudinary one) ---
        // Since I can't see your specific uploadToCloudinary function, I'm adding a basic one.
        // IF YOU HAVE YOUR OWN, DELETE THIS AND PASTE YOURS.
        window.uploadToCloudinary = async (file) => {
             const formData = new FormData();
             formData.append("file", file);
             formData.append("upload_preset", "ml_default"); // CHECK YOUR PRESET NAME
             formData.append("cloud_name", "YOUR_CLOUD_NAME"); // CHECK YOUR CLOUD NAME

             try {
                 const response = await fetch(`https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/upload`, {
                     method: "POST",
                     body: formData
                 });
                 const data = await response.json();
                 return data.secure_url;
             } catch (e) {
                 console.error("Upload error", e);
                 return null;
             }
        };

        // --- CREATE POST LOGIC ---
        document.getElementById("postBtn").addEventListener("click", async () => {
            const btn = document.getElementById("postBtn");
            const text = document.getElementById("postInput").value;
            const dateInput = document.getElementById("capsule-date");
            
            if (!text && !finalPostImage) return;

            btn.innerText = "Posting...";
            
            try {
                // FEATURE 1: Capture Time Capsule Date
                const unlockDate = dateInput.value ? new Date(dateInput.value).getTime() : null;

                await addDoc(postsRef, {
                    text: text,
                    imageUrl: finalPostImage,
                    author: currentUser.uid,
                    username: currentUser.displayName,
                    userPic: currentUser.photoURL,
                    userEmail: currentUser.email,
                    timestamp: serverTimestamp(),
                    likes: [],
                    voiceNotes: [], // Prepare for voice notes
                    unlockAt: unlockDate // SAVE THE DATE
                });

                // Reset Form
                document.getElementById("postInput").value = "";
                document.getElementById("mediaPreview").innerHTML = "";
                if(dateInput) dateInput.value = ""; 
                finalPostImage = null;
                btn.innerText = "Post";
            } catch (err) {
                console.error(err);
                alert("Error posting: " + err.message);
                btn.innerText = "Post";
            }
        });

        // --- LOAD FEED (With Time Capsule Logic) ---
        function loadFeed() {
            const q = query(postsRef, orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const feed = document.getElementById("feed");
                feed.innerHTML = ""; // Clear feed to rebuild (simplest way)

                snapshot.forEach((docSnap) => {
                    const p = docSnap.data();
                    const id = docSnap.id;
                    const el = document.createElement("div");
                    el.className = "post";
                    el.id = `post-${id}`;

                    // --- TIME CAPSULE CHECK ---
                    const now = new Date().getTime();
                    
                    if (p.unlockAt && now < p.unlockAt) {
                         // IS LOCKED
                         const timeToWait = p.unlockAt - now;
                         const unlockDateString = new Date(p.unlockAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                         
                         el.innerHTML = `
                            <div class="user-header">
                                <div class="avatar" style="background-image:url('${p.userPic}')"></div>
                                <div class="user-meta"><h4>${p.username}</h4><span>Locked Post üîí</span></div>
                            </div>
                            <div id="lock-card-${id}" style="padding: 30px; text-align: center; border: 1px dashed #bf00ff; background: rgba(191, 0, 255, 0.05); border-radius: 10px;">
                                <div style="font-size: 40px; margin-bottom: 10px;">üîí</div>
                                <h3 style="color: #bf00ff; margin: 0;">Time Capsule</h3>
                                <p style="color: #aaa; font-size: 12px;">Unlocks at <b style="color:white;">${unlockDateString}</b></p>
                            </div>
                        `;

                        // Auto-Unlock Timer
                        if (timeToWait > 0 && timeToWait < 2000000000) {
                            setTimeout(() => {
                                const card = document.getElementById(`lock-card-${id}`);
                                if(card) {
                                    card.innerHTML = `<h3 style="color:#00ff00;">üîì Unlocking...</h3>`;
                                    setTimeout(() => { el.innerHTML = getPostHTML(id, p); }, 1000);
                                }
                            }, timeToWait);
                        }
                    } else {
                        // UNLOCKED (Normal)
                        el.innerHTML = getPostHTML(id, p);
                    }
                    feed.appendChild(el);
                });
            });
        }

        // --- GET POST HTML (With Voice Player & Button) ---
        function getPostHTML(id, p) {
            const isA = p.userEmail === ADMIN_EMAIL; 
            const b = isA ? `<span style="color:#ffd700; margin-left:4px;">üëë</span>` : "";
            let as = ""; 
            if(isA) as = "background-image:url('https://refivenine.github.io/Evtx/logo.png'); border-color:#ffd700;"; 
            else if(p.userPic) as = `background-image:url('${p.userPic}')`;
            
            let media = "";
            if (p.videoUrl) media = `<video src="${p.videoUrl}" controls class="post-video-frame"></video>`;
            else if (p.imageUrl) media = `<img src="${p.imageUrl}" class="post-img">`;

            // --- BUILD VOICE PLAYER ---
            let voiceHTML = "";
            if (p.voiceNotes && p.voiceNotes.length > 0) {
                voiceHTML = `<div style="margin-top:5px; padding:5px; background:rgba(255,255,255,0.05); border-radius:5px;">`;
                p.voiceNotes.forEach(note => {
                    voiceHTML += `
                        <div style="display:flex; align-items:center; margin-bottom:5px;">
                            <span style="font-size:10px; color:#bf00ff; margin-right:5px;">${note.name}:</span>
                            <audio controls src="${note.url}" style="height:25px; width:180px;"></audio>
                        </div>`;
                });
                voiceHTML += `</div>`;
            }

            const iL = p.likes && p.likes.includes(currentUser.uid); 
            const lc = iL ? "act-btn liked" : "act-btn";

            return `<div class="user-header"><div class="avatar" style="${as}"></div><div class="user-meta"><h4>${p.username} ${b}</h4><span>${new Date(p.timestamp?.toDate()).toLocaleDateString()}</span></div></div>
                    <div class="content">${p.text}</div>
                    ${media}
                    ${voiceHTML}
                    <div class="actions">
                        <button class="${lc}" onclick="likePost('${id}')">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <span>${p.likes ? p.likes.length : 0}</span>
                        </button>
                        <button class="act-btn">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </button>
                        <button onclick="toggleVoiceRecording('${id}')" class="act-btn" id="mic-btn-${id}">
                            üé§ <span id="mic-status-${id}" style="font-size:12px;">Voice</span>
                        </button>
                    </div>`;
        }

        // --- VOICE RECORDING LOGIC (FEATURE 2) ---
        let mediaRecorder;
        let audioChunks = [];
        let activeRecordingId = null;

        window.toggleVoiceRecording = async (postId) => {
            const btn = document.getElementById(`mic-btn-${postId}`);
            const status = document.getElementById(`mic-status-${postId}`);

            if (activeRecordingId === postId && mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                btn.style.color = ""; 
                status.innerText = "Sending...";
                activeRecordingId = null;
                return;
            }

            if (activeRecordingId) { alert("Already recording!"); return; }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                activeRecordingId = postId;
                btn.style.color = "red";
                status.innerText = "Tap to Send";

                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    // NOTE: This uses the Cloudinary function defined above
                    const audioUrl = await uploadToCloudinary(audioBlob); 
                    
                    if(audioUrl) {
                        const postRef = doc(db, "posts", postId);
                        await updateDoc(postRef, {
                            voiceNotes: arrayUnion({
                                url: audioUrl,
                                name: currentUserName,
                                timestamp: Date.now()
                            })
                        });
                        status.innerText = "Sent!";
                        setTimeout(() => status.innerText = "Voice", 2000);
                    } else {
                        status.innerText = "Error";
                    }
                };
                mediaRecorder.start();
            } catch (err) {
                console.error(err);
                alert("Mic error: " + err.message);
            }
        };

        // --- GLOBAL LIKE FUNCTION ---
        window.likePost = async (postId) => {
            if(!currentUser) return;
            const postRef = doc(db, "posts", postId);
            const pDoc = await getDoc(postRef);
            if(pDoc.exists()) {
                const likes = pDoc.data().likes || [];
                if(likes.includes(currentUser.uid)) {
                    // Unlike logic would go here (remove from array)
                    // For now, simpler to just implement Like
                } else {
                    await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
                }
            }
        };

        // --- HANDLE FILE INPUT ---
        document.getElementById("fileInput").addEventListener("change", async (e) => {
             const file = e.target.files[0];
             if(file) {
                 document.getElementById("mediaPreview").innerText = "Uploading media...";
                 finalPostImage = await uploadToCloudinary(file);
                 document.getElementById("mediaPreview").innerHTML = `<img src="${finalPostImage}" style="height:50px; border-radius:5px;">`;
             }
        });

    </script>
</body>
</html>
