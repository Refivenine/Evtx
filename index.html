<!DOCTYPE html>
<html>
<head>
    <title>EVTX | Network</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#bf00ff">
    <link rel="apple-touch-icon" href="https://refivenine.github.io/Evtx/logo.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* --- DESIGN ENGINE --- */
        :root { --app-color: #bf00ff; }
        body {
            background: linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.98)), url('https://refivenine.github.io/cover2.jpg');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; padding-bottom: 80px;
            overscroll-behavior: none;
        }

        .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .hidden { display: none !important; }
        .btn { border: none; outline: none; cursor: pointer; background: none; }

        /* SPLASH */
        #splash-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.5s ease;
        }
        .pulse-logo { font-weight: 900; color: #fff; font-size: 40px; letter-spacing: 2px; animation: pulse 1.5s infinite; }
        .pulse-logo span { color: var(--app-color); }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }

        /* FRIEND BUTTON */
        .friend-btn {
            background: #333; color: #fff; padding: 8px 20px; border-radius: 20px; font-size: 13px;
            font-weight: bold; margin-right: 10px; transition: 0.2s; border: 1px solid #444; cursor: pointer;
        }
        .friend-btn.add { background: var(--app-color); border-color: var(--app-color); }
        .friend-btn.requested { background: #222; color: #888; }
        .friend-btn.accept { background: #00c853; border-color: #00c853; } 
        .friend-btn.friends { background: #111; color: var(--app-color); border-color: var(--app-color); }

        /* NOTIFICATIONS */
        .notif-item { 
            display: flex; align-items: center; background: #151515; padding: 15px; 
            border-bottom: 1px solid #222; cursor: pointer; transition: background 0.1s;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .notif-item:active { background: #2a2a2a; transform: scale(0.99); }
        .notif-item.unread { background: #1a1a2e; border-left: 3px solid var(--app-color); }
        .notif-icon { margin-right: 15px; color: var(--app-color); font-size: 20px; } 
        .notif-text { font-size: 14px; color: #ddd; flex: 1; pointer-events: none; }
        .notif-user-link { font-weight: bold; color: #fff; cursor: pointer; z-index: 10; position: relative; text-decoration: underline; }

        /* NEWS TAB */
        .news-header { padding: 15px; background: rgba(20,20,20,0.9); border-bottom: 1px solid #333; display: flex; align-items: center; gap: 10px; backdrop-filter: blur(5px); }
        .news-badge { background: linear-gradient(45deg, #ff0055, #ff5500); padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: bold; color: #fff; }
        .news-card { background: #151515; margin: 15px; border-radius: 15px; overflow: hidden; border: 1px solid #333; animation: fadeIn 0.5s; }
        .news-img { width: 100%; height: 180px; object-fit: cover; background: #222; }
        .news-content { padding: 15px; }
        .news-ai-tag { display: inline-block; background: #222; color: var(--app-color); border: 1px solid var(--app-color); font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; }
        .news-title { margin: 0 0 10px 0; font-size: 16px; line-height: 1.4; color: #fff; }
        .news-desc { font-size: 13px; color: #888; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .news-meta { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #555; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* BADGES */
        .nav-item { position: relative; color: #555; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-active { color: var(--app-color); }
        .badge {
            position: absolute; top: -5px; right: -5px; background: #ff0000; color: #fff;
            font-size: 10px; font-weight: 900; min-width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; border: 2px solid #000;
            z-index: 10; display: none;
        }

        /* CROPPER */
        #cropper-modal { position: fixed; inset: 0; background: #000; z-index: 6000; display: flex; flex-direction: column; }
        .crop-area { flex: 1; min-height: 0; position: relative; background: #111; overflow: hidden; }
        .crop-controls { flex-shrink: 0; height: 70px; background: #151515; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 6001; padding-bottom: env(safe-area-inset-bottom); }
        #image-to-crop { max-width: 100%; display: block; }

        /* AUTH */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .auth-box { background: #151515; padding: 30px; border-radius: 20px; border: 1px solid var(--app-color); width: 85%; max-width: 350px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; box-sizing: border-box; }
        .main-btn { width: 100%; padding: 12px; background: var(--app-color); color: #fff; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; border: none; }

        /* HEADER */
        .header { background: rgba(10, 10, 10, 0.95); padding: 15px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(10px); }
        .logo { font-weight: 900; color: #fff; font-size: 22px; letter-spacing: 1px; } .logo span { color: var(--app-color); }
        .container { max-width: 600px; margin: 0 auto; padding: 0; }

        /* CHAT */
        .chat-list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; background: #151515; transition: 0.2s; }
        .chat-list-item.unread-chat { background: #1a1a2e; border-left: 3px solid var(--app-color); }
        .chat-preview { margin-left: 15px; flex: 1; } .chat-name { font-weight: bold; color: #fff; margin: 0; } .chat-last-msg { color: #777; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .unread-dot { width: 8px; height: 8px; background: var(--app-color); border-radius: 50%; margin-left: 10px; display: none; }
        #chat-room { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; }
        .chat-header { padding: 15px; background: #151515; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 20px; font-size: 14px; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: var(--app-color); color: #fff; border-bottom-right-radius: 2px; } .msg-them { align-self: flex-start; background: #222; color: #ddd; border-bottom-left-radius: 2px; }
        .chat-input-area { padding: 15px; background: #151515; border-top: 1px solid #333; display: flex; gap: 10px; padding-bottom: max(15px, env(safe-area-inset-bottom)); }

        /* POSTS & FEED */
        .create-box { background: #151515; padding: 15px; border-radius: 12px; border: 1px solid #333; margin: 15px; margin-bottom: 25px; }
        textarea#postInput { width: 100%; background: #080808; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 10px; resize: none; box-sizing: border-box; outline: none; }
        .post { background: #151515; border-radius: 15px; padding: 15px; margin: 15px; margin-bottom: 15px; border: 1px solid #222; }
        /* --- GLASSY PRO CARD EFFECT --- */
.post, .create-box, .profile-container, .auth-box, .news-card {
    background: rgba(255, 255, 255, 0.05) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    border-top: 1px solid rgba(255, 255, 255, 0.15) !important;
    border-radius: 24px !important;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3) !important;
    padding: 20px;
    margin-bottom: 20px;
}
        .user-header { display: flex; align-items: center; margin-bottom: 12px; }
        .avatar { width: 40px; height: 40px; background: #333; border-radius: 50%; margin-right: 12px; border: 2px solid #333; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; }
        .user-meta h4 { margin: 0; color: #fff; font-size: 15px; cursor: pointer; } .user-meta span { font-size: 12px; color: #777; }
        .content { font-size: 15px; line-height: 1.5; color: #ddd; margin-bottom: 10px; white-space: pre-wrap; }
        .post-img { width: 100%; border-radius: 12px; margin-top: 5px; border: 1px solid #333; max-height: 500px; object-fit: contain; background: #000; }
        .post-video-frame { width: 100%; aspect-ratio: 16/9; border-radius: 12px; margin-top: 5px; border: none; background: #000; }
        /* --- PRO NEON BUTTONS --- */
.actions {
    display: flex;
    justify-content: space-between;
    padding-top: 15px;
    margin-top: 15px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.act-btn {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #aaa;
    padding: 8px 16px;
    border-radius: 15px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex;
    align-items: center;
    gap: 8px;
}

.act-btn svg {
    width: 18px; 
    height: 18px;
    fill: currentColor;
    transition: transform 0.2s;
}

.act-btn:hover {
    transform: translateY(-3px);
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.act-btn:hover svg { transform: scale(1.15); }

/* COLOR GLOWS */
.actions button:nth-child(1):hover, .liked { color: #ff0055 !important; border-color: rgba(255, 0, 85, 0.3); box-shadow: 0 5px 15px rgba(255, 0, 85, 0.2); }
.liked svg { fill: #ff0055; stroke: none; }

.actions button:nth-child(2):hover { color: #00e5ff !important; border-color: rgba(0, 229, 255, 0.3); box-shadow: 0 5px 15px rgba(0, 229, 255, 0.2); }

.actions button:nth-child(3):hover { color: #00ff99 !important; border-color: rgba(0, 255, 153, 0.3); box-shadow: 0 5px 15px rgba(0, 255, 153, 0.2); }

.actions button:nth-child(4):hover { color: #ff3300 !important; border-color: rgba(255, 51, 0, 0.3); box-shadow: 0 5px 15px rgba(255, 51, 0, 0.2); }
        .comments-section { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; }
        .comment-input-row { display: flex; gap: 10px; margin-top: 10px; }
        .mini-input { width: 100%; background: #000; border: 1px solid #333; padding: 8px; border-radius: 20px; color: #fff; outline: none; }
        .mini-btn { background: #333; color: #fff; border-radius: 20px; padding: 5px 15px; font-size: 12px; }
        .single-comment { font-size: 13px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #222; } .c-user { color: var(--app-color); font-weight: bold; margin-right: 5px; }
        #edit-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .edit-modal { background: #1a1a1a; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; border: 1px solid #333; }
        
        /* POST VIEW OVERLAY */
        #post-view-overlay { position: fixed; inset: 0; background: #000; z-index: 6000; overflow-y: auto; }
        .p-view-header { position: sticky; top: 0; background: rgba(10,10,10,0.95); padding: 15px; border-bottom: 1px solid #333; display: flex; gap: 15px; align-items: center; z-index: 10; backdrop-filter: blur(5px); }

        /* PROFILE LAYOUTS */
        .profile-container { background: #151515; border-radius: 0 0 20px 20px; overflow: hidden; border: 1px solid #333; border-top: none; margin-bottom: 20px; }
        .cover-photo-container { position: relative; width: 100%; height: 180px; background: #222; background-size: cover; background-position: center; border-bottom: 3px solid var(--app-color); transition: border-color 0.3s; }
        .big-avatar { width: 110px; height: 110px; border-radius: 50%; border: 4px solid #151515; background-size: cover; background-position: center; background-color: #333; position: absolute; bottom: -55px; left: 50%; transform: translateX(-50%); z-index: 10; transition: border-color 0.3s; }
        .edit-cover-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .profile-header-overlap { position: relative; margin-bottom: 60px; }
        .edit-pic-btn { position: absolute; bottom: -50px; left: 50%; transform: translateX(35px); z-index: 11; background: var(--app-color); color: #fff; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .form-section { padding: 20px; padding-top: 0; }
        .form-label { color: var(--app-color); font-size: 12px; margin-top: 20px; display: block; font-weight: 700; letter-spacing: 1px; }
        .form-input { width: 100%; background: #080808; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; box-sizing: border-box; }
        .form-input:focus { border-color: var(--app-color); outline: none; }
        .color-picker-wrapper { display: flex; align-items: center; gap: 15px; background: #080808; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 40px; height: 40px; border-radius: 50%; overflow: hidden; padding: 0; margin: 0; cursor: pointer; }
        
        .public-bio-box { text-align: center; padding: 0 20px 20px 20px; } 
        .public-name { font-size: 22px; font-weight: bold; margin: 0; color: #fff; display: block; min-height: 30px; } 
        .public-nick { color: var(--app-color); font-size: 14px; margin-bottom: 10px; display: block; min-height: 20px; }
        .public-stats { display: flex; justify-content: center; gap: 15px; margin-top: 15px; color: #777; font-size: 13px; } 
        .stat-tag { background: #222; padding: 4px 10px; border-radius: 10px; border: 1px solid #333; }
        .back-btn-float { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); color: #fff; padding: 8px 12px; border-radius: 20px; backdrop-filter: blur(5px); z-index: 20; border: none; font-weight: bold; cursor: pointer;}

        /* PROFILE TABS & GALLERY */
        .profile-tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .p-tab-btn { flex: 1; padding: 15px; text-align: center; color: #777; cursor: pointer; font-weight: bold; font-size: 14px; position: relative; }
        .p-tab-active { color: var(--app-color); }
        .p-tab-active::after { content: ''; position: absolute; bottom: 0; left: 25%; width: 50%; height: 3px; background: var(--app-color); border-radius: 3px 3px 0 0; }
        
        .grid-gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 5px; }
        .grid-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 4px; cursor: pointer; background: #222; }
        
        .friend-item { display: flex; align-items: center; padding: 12px; background: #1a1a1a; margin-bottom: 8px; border-radius: 12px; }
        .friend-info { flex: 1; margin-left: 12px; }
        
        .vid-btn { background:#222; border:1px solid #333; color:#fff; padding:6px 12px; border-radius:15px; font-size:12px; display:flex; align-items:center; gap:5px; cursor:pointer; }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; padding: 12px 0; z-index: 2000; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        .search-bar { width: 90%; margin: 15px auto; display:block; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 30px; outline: none; box-sizing: border-box; }
        .user-result { display: flex; align-items: center; background: #1a1a1a; padding: 10px; border-radius: 15px; margin: 10px 15px; cursor: pointer; }
        /* --- PRO PROFILE UPGRADE --- */

/* 1. Futuristic Inputs */
.form-input {
    background: rgba(0, 0, 0, 0.4) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 15px !important;
    color: white !important;
    padding: 15px !important;
    font-size: 14px;
    transition: all 0.3s ease;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
}

.form-input:focus {
    border-color: var(--app-color) !important;
    box-shadow: 0 0 15px rgba(191, 0, 255, 0.3), inset 0 2px 5px rgba(0,0,0,0.5);
    background: rgba(0, 0, 0, 0.8) !important;
    transform: scale(1.01);
}

/* 2. Cyber Labels */
.form-label {
    font-size: 10px !important;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--app-color) !important;
    margin-bottom: 8px;
    margin-top: 25px;
    font-weight: 900;
    opacity: 0.9;
}

/* 3. Pro "Edit" Buttons */
.edit-pic-btn, .edit-cover-btn {
    background: rgba(0, 0, 0, 0.6) !important;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: white !important;
    border-radius: 50px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
    cursor: pointer;
}

.edit-pic-btn:hover, .edit-cover-btn:hover {
    background: var(--app-color) !important;
    box-shadow: 0 0 20px var(--app-color);
    border-color: white !important;
    transform: scale(1.1) rotate(5deg);
}

/* 4. Color Picker Control */
.color-picker-wrapper {
    background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(0,0,0,0.2)) !important;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.1);
    padding: 10px 15px !important;
}
    </style>
</head>
<body>
    <div id="splash-screen"><div class="pulse-logo">EV<span>TX</span></div><div style="color:#777; margin-top:10px; font-size:12px;">ESTABLISHING UPLINK...</div></div>
    
    <div id="auth-screen" class="hidden"><div class="logo" style="margin-bottom: 20px; font-size: 40px;">EV<span>TX</span></div><div class="auth-box"><h2 id="auth-title" style="color:#fff;">Login</h2><input type="email" id="email" class="auth-input" placeholder="Email"><input type="password" id="password" class="auth-input" placeholder="Password"><button id="auth-action-btn" class="main-btn">Enter Network</button><p id="toggle-auth-btn" style="color:#777; font-size:14px; text-decoration:underline; cursor:pointer;">New here? Create Account</p></div></div>
    
    <div id="cropper-modal" class="hidden"><div class="crop-area"><img id="image-to-crop" src=""></div><div class="crop-controls"><button onclick="cancelCrop()" class="btn" style="color:#ddd; font-weight:bold;">Cancel</button><button onclick="performCrop()" class="main-btn" style="width:auto; margin:0; padding:8px 25px;">‚úÇÔ∏è Save</button></div></div>

    <div id="app-screen" class="hidden">
        <div class="header"><div class="logo">EV<span>TX</span></div><button onclick="logout()" class="btn" style="color:#777; font-size:12px;">Log Out</button></div>
        
        <div id="chat-room" class="hidden"><div class="chat-header"><button onclick="closeChat()" class="btn" style="color:#fff;">‚¨Ö</button><div id="chat-with-pic" class="avatar" style="width:35px; height:35px;"></div><h4 id="chat-with-name" style="margin:0; color:#fff;">User</h4></div><div id="chat-messages" class="chat-messages"></div><div class="chat-input-area"><input type="text" id="msg-input" class="mini-input" placeholder="Type a message..."><button onclick="sendMessage()" class="btn" style="color:var(--app-color);"><svg class="icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button></div></div>
        
        <div id="post-view-overlay" class="hidden">
            <div class="p-view-header"><button onclick="closePostView()" class="btn" style="color:#fff; font-size: 20px;">‚¨Ö</button><h3 style="margin:0;color:#fff;">Post</h3></div>
            <div id="single-post-content" class="container" style="padding-top:10px;"></div>
        </div>

        <div class="container">
            <div id="tab-home" class="tab-content">
                <div class="create-box">
                    <textarea id="postInput" rows="2" placeholder="What is happening?"></textarea>
                    <div id="mediaPreview" style="color: var(--app-color); font-size: 12px; margin: 5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <div style="display:flex; gap:10px;">
                            <label for="fileInput" class="vid-btn"><svg class="icon" style="width:16px;height:16px;" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> Media</label>
                            <input type="file" id="fileInput" accept="image/*,video/*" hidden>
                        </div>
                        <button id="sendBtn" class="main-btn" style="width:auto; margin:0; padding:8px 20px;">Post</button>
                    </div>
                </div>
                <div id="feed">Loading...</div>
            </div>

            <div id="tab-news" class="tab-content hidden">
                <div class="news-header">
                    <h3 style="margin:0;color:#fff;">AI Brief</h3>
                    <div class="news-badge">LIVE</div>
                </div>
                <div id="news-feed" style="padding-bottom:20px;">Loading global intelligence...</div>
            </div>

            <div id="tab-chats" class="tab-content hidden"><h3 style="padding:15px; margin:0; border-bottom:1px solid #222;">Messages</h3><div id="chat-list"><div style="text-align:center; padding:20px; color:#555;">No conversations yet.</div></div></div>

            <div id="tab-search" class="tab-content hidden"><input type="text" id="searchInput" class="search-bar" placeholder="üîç Search users..."><div id="searchResults"></div></div>

            <div id="tab-notifs" class="tab-content hidden"><h3 style="padding:15px; margin:0; border-bottom:1px solid #222;">Activity</h3><div id="notif-list"><div style="text-align:center; padding:20px; color:#555;">No notifications yet.</div></div></div>
            
            <div id="tab-profile" class="tab-content hidden"><div class="profile-container"><div class="profile-header-overlap"><div id="my-cover-pic" class="cover-photo-container"><button onclick="document.getElementById('coverPicInput').click()" class="edit-cover-btn">üì∑ Edit Cover</button></div><div id="my-pic" class="big-avatar"></div><button onclick="document.getElementById('profilePicInput').click()" class="edit-pic-btn">üì∑</button></div><input type="file" id="profilePicInput" hidden accept="image/*"><input type="file" id="coverPicInput" hidden accept="image/*"><div class="form-section"><label class="form-label">AURA COLOR</label><div class="color-picker-wrapper"><input type="color" id="p-theme" value="#bf00ff"><span style="font-size:13px; color:#777;">Pick a color that represents you.</span></div><label class="form-label">DISPLAY NAME</label><input type="text" id="p-name" class="form-input"><label class="form-label">NICKNAME</label><input type="text" id="p-nickname" class="form-input"><label class="form-label">BIO</label><textarea id="p-bio" class="form-input" rows="3"></textarea><label class="form-label">COUNTRY</label><input type="text" id="p-country" class="form-input"><button id="saveProfileBtn" class="main-btn" style="margin-top: 30px; margin-bottom: 20px;">üíæ Save Changes</button><button id="viewMyProfileBtn" class="friend-btn" style="width:100%; text-align:center; margin-top:10px; border-color:#555;">üëÄ View My Public Profile</button></div></div></div>
            
            <div id="tab-user-view" class="tab-content hidden"><div class="profile-container"><div class="cover-photo-container" id="view-cover"><button onclick="goBack()" class="back-btn-float">‚¨Ö Back</button></div><div class="profile-header-overlap" style="margin-bottom:50px;"><div id="view-pic" class="big-avatar"></div></div><div class="public-bio-box"><h2 id="view-name" class="public-name">Loading...</h2><span id="view-nick" class="public-nick"></span><p id="view-bio" style="color:#ddd; margin:15px 0;">...</p><div style="display:flex; justify-content:center; gap:10px;"><button id="message-user-btn" class="main-btn" style="width:auto; padding:8px 20px; font-size:14px;">üí¨ Message</button><button id="friend-user-btn" class="friend-btn">Add Friend</button></div><div class="public-stats"><span id="view-country" class="stat-tag">üè≥Ô∏è ...</span></div></div><div class="profile-tabs"><div class="p-tab-btn p-tab-active" onclick="switchProfileTab('posts')" id="pt-posts">Posts</div><div class="p-tab-btn" onclick="switchProfileTab('images')" id="pt-images">Media</div><div class="p-tab-btn" onclick="switchProfileTab('friends')" id="pt-friends">Friends</div></div></div><div id="user-posts-feed" class="p-content-box"></div><div id="user-images-feed" class="p-content-box hidden grid-gallery"></div><div id="user-friends-list" class="p-content-box hidden" style="padding:10px;"></div></div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item nav-active" onclick="switchTab('home')"><svg class="icon" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></div>
            <div class="nav-item" onclick="switchTab('news')"><svg class="icon" viewBox="0 0 24 24"><path d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
            <div class="nav-item" onclick="switchTab('chats')"><svg class="icon" viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg><div id="chat-badge" class="badge">0</div></div>
            <div class="nav-item" onclick="switchTab('search')"><svg class="icon" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
            <div class="nav-item" onclick="switchTab('notifs')"><svg class="icon" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg><div id="notif-badge" class="badge">0</div></div>
            <div class="nav-item" onclick="switchTab('profile')"><svg class="icon" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
        </div>
    </div>
<script type="module">
    // --- 1. IMPORTS (Unified & Fixed) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, getDoc, deleteDoc, setDoc, arrayRemove, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    
    // --- 2. CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyAiaKBfUC4QScczQq6wARW7KC0-gKcomg8",
        authDomain: "evtx-social.firebaseapp.com",
        projectId: "evtx-social",
        storageBucket: "evtx-social.appspot.com",
        messagingSenderId: "338908722677",
        appId: "1:338908722677:web:253109017684"
    };

    const CLOUD_NAME = "dcuhf22ke";
    const UPLOAD_PRESET = "evtx_preset";
    const ADMIN_EMAIL = "refivenine@gmail.com";

    // --- 3. INITIALIZE APP ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const postsRef = collection(db, "posts");

    // --- 4. GLOBAL VARIABLES ---
    let currentUser = null; 
    window.currentUser = null; 
    
    let currentUserName = "User"; let currentChatId = null;
    let cropper = null; let cropTarget = null; let finalPostImage = null; let finalProfilePic = null; let finalCoverPic = null;
    let friendListener = null; let currentUserViewing = null; let selectedVideoFile = null;

    // --- 5. THEME HELPERS ---
    window.applyTheme = (color) => { const c = color || "#bf00ff"; document.documentElement.style.setProperty('--app-color', c); };
    window.applyUserViewTheme = (color) => { const c = color || "#bf00ff"; document.getElementById('view-cover').style.borderBottomColor = c; document.getElementById('view-nick').style.color = c; };

    // --- 6. AUTH LISTENER (The Engine Starter) ---
    onAuthStateChanged(auth, async (user) => {
        const splash = document.getElementById("splash-screen");
        if (user) {
            // User is Logged In
            currentUser = user; 
            window.currentUser = user; 
            
            document.getElementById("auth-screen").classList.add("hidden");
            document.getElementById("app-screen").classList.remove("hidden");
            
            // Start All Systems
            loadFeed();
            listenForNotifications();
            loadChatList();
            listenForChatBadges();
            
            // Get User Profile Data
            const uDoc = await getDoc(doc(db, "users", user.uid));
            if(uDoc.exists()) {
                const d = uDoc.data();
                currentUserName = d.name || user.email.split('@')[0];
                applyTheme(d.themeColor);
                
                // Fill Profile Page Inputs
                const pPic = document.getElementById('p-name');
                if(pPic) {
                     document.getElementById('p-name').value = d.name || "";
                     document.getElementById('p-nickname').value = d.nickname || ""; 
                     document.getElementById('p-bio').value = d.bio || "";
                     if(d.pic) document.getElementById('my-pic').style.backgroundImage = `url('${d.pic}')`;
                     if(d.coverPic) document.getElementById('my-cover-pic').style.backgroundImage = `url('${d.coverPic}')`;
                }
            }
        } else {
            // User is Logged Out
            document.getElementById("auth-screen").classList.remove("hidden");
            document.getElementById("app-screen").classList.add("hidden");
        }
        
        // Remove Splash Screen
        if(splash) {
            setTimeout(() => { splash.style.opacity = "0"; setTimeout(() => splash.style.display = "none", 500); }, 1000);
        }
    });

    // --- 7. CLOUD UPLOAD ---
    async function uploadToCloudinary(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', UPLOAD_PRESET);
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
            method: 'POST', body: formData
        });
        const data = await response.json();
        return data.secure_url;
    }

    // --- 8. FEED SYSTEM ---
    window.loadFeed = () => {
        const feed = document.getElementById("feed");
        if(!feed) return;
        
        const q = query(postsRef, orderBy("createdAt", "desc"));
        
        onSnapshot(q, (snapshot) => {
            if(feed.innerHTML === "Loading...") feed.innerHTML = "";
            
            snapshot.docChanges().forEach(change => {
                const p = change.doc.data();
                const id = change.doc.id;
                
                if (change.type === "added") {
                    const el = document.createElement("div");
                    el.className = "post";
                    el.id = `post-${id}`;
                    el.innerHTML = getPostHTML(id, p);
                    if (change.newIndex >= feed.children.length) feed.appendChild(el); 
                    else feed.insertBefore(el, feed.children[change.newIndex]);
                }
                if (change.type === "modified") {
                    const el = document.getElementById(`post-${id}`);
                    if (el) el.innerHTML = getPostHTML(id, p);
                }
                if (change.type === "removed") {
                    const el = document.getElementById(`post-${id}`);
                    if(el) el.remove();
                }
            });
            if(snapshot.empty) feed.innerHTML = "<div style='text-align:center; padding:40px; color:#888;'>No posts yet.</div>";
        });
    };

    // --- 9. POST HTML BUILDER ---
    window.getPostHTML = (id, p, suffix = "") => {
        const isMe = currentUser && (p.uid === currentUser.uid);
        const delBtn = isMe ? `<button onclick="deletePost('${id}')" class="act-btn" style="color:#ff3300;">üóëÔ∏è</button>` : "";
        const isA = p.userEmail === ADMIN_EMAIL; 
        const b = isA ? `<span style="color:#ffd700; margin-left:4px;">üëë</span>` : "";
        
        let as = ""; 
        if(isA) as = "background-image:url('https://refivenine.github.io/Evtx/logo.png'); border-color:#ffd700;"; 
        else if(p.userPic) as = `background-image:url('${p.userPic}')`;

        let media = "";
        if (p.videoUrl) media = `<video src="${p.videoUrl}" controls class="post-video-frame"></video>`;
        else if (p.imageUrl) media = `<img src="${p.imageUrl}" class="post-img">`;

        let voiceHTML = "";
        if (p.voiceNotes && p.voiceNotes.length > 0) {
            voiceHTML = `<div style="margin-top:10px; padding:8px; background:rgba(0,0,0,0.3); border-radius:10px;">`;
            p.voiceNotes.forEach(note => {
                voiceHTML += `<div style="display:flex; align-items:center; margin-bottom:5px;"><span style="font-size:10px; color:#bf00ff; margin-right:5px;">${note.name}:</span><audio controls src="${note.url}" style="height:25px; width:180px;"></audio></div>`;
            });
            voiceHTML += `</div>`;
        }

        const iL = p.likes && p.likes.includes(currentUser.uid); 
        const lc = iL ? "act-btn liked" : "act-btn";
        const commentSectionId = `comments-${id}${suffix}`;
        const inputId = `comment-input-${id}${suffix}`;

        return `
            <div class="user-header">
                <div class="avatar" style="${as}" onclick="openUserProfile('${p.uid}')"></div>
                <div class="user-meta" onclick="openUserProfile('${p.uid}')"><h4>${p.username} ${b}</h4><span>${p.userBio || "Member"}</span></div>
            </div>
            <div class="content">${p.text}</div>
            ${media}
            ${voiceHTML}
            <div class="actions">
                <button class="${lc}" onclick="likePost('${id}')"><svg class="icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span>${p.likes ? p.likes.length : 0}</span></button>
                <button class="act-btn" onclick="toggleComments('${commentSectionId}')"><svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg><span>${p.comments ? p.comments.length : 0}</span></button>
                <button class="act-btn" onclick="sharePost('${id}')"><svg class="icon" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg></button>
                <button onclick="toggleVoiceRecording('${id}')" class="act-btn" id="mic-btn-${id}">üé§ <span id="mic-status-${id}" style="font-size:12px;">Voice</span></button>
                ${delBtn}
            </div>
            <div id="${commentSectionId}" class="comments-section" style="display:none;">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input id="${inputId}" type="text" class="mini-input" placeholder="Write a comment...">
                    <button onclick="addComment('${id}', '${inputId}')" class="main-btn" style="padding:5px 15px; font-size:12px;">Send</button>
                </div>
                <div style="max-height:200px; overflow-y:auto; font-size:13px; color:#ccc;">
                    ${p.comments ? p.comments.map(c => `<div style="margin-bottom:8px; padding:8px; background:rgba(255,255,255,0.05); border-radius:10px;"><b style="color:#bf00ff;">${c.username}:</b> ${c.text}</div>`).join('') : '<div style="opacity:0.5;">No comments yet.</div>'}
                </div>
            </div>`;
    };

    // --- 10. NOTIFICATIONS ---
    window.listenForNotifications = () => {
        if(!currentUser) return;
        const notifList = document.getElementById("notif-list");
        const badge = document.getElementById("notif-badge");
        
        const q = query(collection(db, "notifications"), where("recipient", "==", currentUser.uid), orderBy("time", "desc"));
        
        onSnapshot(q, (snapshot) => {
            if(notifList) notifList.innerHTML = "";
            let unread = 0;
            if (snapshot.empty && notifList) notifList.innerHTML = "<div style='text-align:center;padding:20px;color:#555;'>No new notifications.</div>";
            
            snapshot.forEach(d => {
                const n = d.data();
                if(!n.read) unread++;
                if(notifList) {
                    const item = document.createElement("div");
                    item.className = `notif-item ${n.read?'':'unread'}`;
                    item.innerHTML = `<div class="notif-icon" style="font-size:20px;margin-right:15px;">${n.type==='like'?'‚ù§Ô∏è':n.type==='comment'?'üí¨':'üîî'}</div><div class="notif-text"><span class="notif-user-link"><b>${n.sender}</b></span> ${n.text}</div>`;
                    item.onclick = async () => {
                         if(!n.read) updateDoc(doc(db,"notifications",d.id),{read:true});
                         if(n.postId) openSinglePost(n.postId);
                    };
                    notifList.appendChild(item);
                }
            });
            if(badge) { badge.innerText = unread; badge.style.display = unread > 0 ? "block" : "none"; }
        });
    };

    // --- 11. CHATS ---
    window.loadChatList = () => {
        const list = document.getElementById("chat-list");
        if(!list || !currentUser) return;
        const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
        
        onSnapshot(q, (snapshot) => {
            list.innerHTML = "";
            if (snapshot.empty) return list.innerHTML = "<div style='padding:20px; text-align:center; color:#666;'>No active chats</div>";
            
            snapshot.forEach(async (docSnap) => {
                const chat = docSnap.data();
                const otherId = chat.participants.find(id => id !== currentUser.uid);
                let otherName = "User"; let otherPic = "";
                const uDoc = await getDoc(doc(db, "users", otherId));
                if(uDoc.exists()) { otherName = uDoc.data().name; otherPic = uDoc.data().pic; }

                const div = document.createElement("div");
                div.className = "chat-list-item";
                div.onclick = () => window.openChatWindow(docSnap.id, otherId);
                div.innerHTML = `<div class="avatar" style="background-image:url('${otherPic}'); width:40px; height:40px;"></div><div class="chat-preview"><h4>${otherName}</h4><span style="font-size:12px;color:#777;">${chat.lastMessage || "Start chatting..."}</span></div>`;
                list.appendChild(div);
            });
        });
    };

    // --- 12. INTERACTIONS ---
    window.createNotification = async (t,y,pid) => { 
        if(!t||t===currentUser.uid)return; 
        let txt="interacted."; 
        if(y==='like')txt="liked your post."; 
        if(y==='comment')txt="commented."; 
        await addDoc(collection(db,"notifications"),{recipient:t, sender:currentUserName, senderUid:currentUser.uid, type:y, text:txt, postId:pid, read:false, time:serverTimestamp()}); 
    };

    window.likePost = async (postId) => {
        if(!currentUser) return;
        const postRef = doc(db, "posts", postId);
        const pDoc = await getDoc(postRef);
        if(pDoc.exists()) {
            const d = pDoc.data();
            const likes = d.likes || [];
            if(!likes.includes(currentUser.uid)) {
                await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
                createNotification(d.uid, 'like', postId);
            }
        }
    };

    window.addComment = async (postId, inputId) => {
        const input = document.getElementById(inputId);
        const text = input.value;
        if(!text) return;
        input.value = "Sending...";
        const postRef = doc(db, "posts", postId);
        const pDoc = await getDoc(postRef);
        
        await updateDoc(postRef, {
            comments: arrayUnion({ text: text, username: currentUserName, uid: currentUser.uid, timestamp: Date.now() })
        });
        if(pDoc.exists()) createNotification(pDoc.data().uid, 'comment', postId);
        input.value = "";
    };

    window.deletePost = async (postId) => {
        if(confirm("Delete this post?")) {
            await deleteDoc(doc(db, "posts", postId));
        }
    };
    
    window.sharePost = () => { navigator.clipboard.writeText(window.location.href); alert("Link copied!"); };
    window.toggleComments = (id) => { const el = document.getElementById(id); if(el) el.style.display = (el.style.display==="none")?"block":"none"; };

    // --- 13. POSTING LOGIC ---
    function initCrop(file, target) { const reader = new FileReader(); reader.onload = (e) => { const img = document.getElementById('image-to-crop'); img.src = e.target.result; document.getElementById('cropper-modal').classList.remove('hidden'); cropTarget = target; if(cropper) cropper.destroy(); let ratio = NaN; if(target === 'pic') ratio = 1; if(target === 'cover') ratio = 16/9; cropper = new Cropper(img, { aspectRatio: ratio, viewMode: 1, autoCropArea: 1, background: false }); }; reader.readAsDataURL(file); }
    window.performCrop = () => { if(!cropper) return; const canvas = cropper.getCroppedCanvas({ maxWidth: 800, maxHeight: 800 }); const url = canvas.toDataURL('image/jpeg', 0.8); if(cropTarget === 'post') { finalPostImage = url; selectedVideoFile = null; document.getElementById('mediaPreview').innerHTML = `<img src="${url}" style="height:50px; border-radius:5px;">`; } else if (cropTarget === 'pic') { finalProfilePic = url; document.getElementById('my-pic').style.backgroundImage = `url('${url}')`; } else if (cropTarget === 'cover') { finalCoverPic = url; document.getElementById('my-cover-pic').style.backgroundImage = `url('${url}')`; } cancelCrop(); };
    window.cancelCrop = () => { document.getElementById('cropper-modal').classList.add('hidden'); if(cropper) { cropper.destroy(); cropper = null; } document.getElementById('fileInput').value = ""; document.getElementById('profilePicInput').value = ""; document.getElementById('coverPicInput').value = ""; };
    
    document.getElementById("fileInput").addEventListener('change', function() { if(this.files[0]) { const file = this.files[0]; if(file.type.startsWith('video/')) { selectedVideoFile = file; finalPostImage = null; document.getElementById('mediaPreview').innerHTML = `<span style="color:var(--app-color);">üìπ Video Selected: ${file.name}</span>`; } else { initCrop(file, 'post'); } } });
    document.getElementById("profilePicInput").addEventListener('change', function() { if(this.files[0]) initCrop(this.files[0], 'pic'); });
    document.getElementById("coverPicInput").addEventListener('change', function() { if(this.files[0]) initCrop(this.files[0], 'cover'); });

    document.getElementById("sendBtn").addEventListener("click", async () => { 
        const i=document.getElementById("postInput"); 
        if(!i.value && !finalPostImage && !selectedVideoFile) return; 
        const btn = document.getElementById("sendBtn");
        btn.innerText="Uploading..."; 
        
        try { 
            let postData = { text:i.value, userEmail:currentUser.email, uid:currentUser.uid, username:currentUserName, userPic: document.getElementById('my-pic').style.backgroundImage.slice(5,-2), userBio:"Member", createdAt:serverTimestamp(), likes:[], comments:[] };
            
            if (selectedVideoFile) { const url = await uploadToCloudinary(selectedVideoFile); postData.videoUrl = url; } 
            else if (finalPostImage) { const url = await uploadToCloudinary(finalPostImage); postData.imageUrl = url; }

            await addDoc(postsRef, postData); 
            i.value=""; finalPostImage=null; selectedVideoFile=null; document.getElementById("fileInput").value=""; document.getElementById("mediaPreview").innerHTML=""; btn.innerText="Post"; 
        } catch (err) { alert("Error: " + err.message); btn.innerText="Post"; } 
    });

    // --- 14. PROFILE & SYSTEM ---
    document.getElementById("saveProfileBtn").addEventListener("click", async () => { 
        const b = document.getElementById("saveProfileBtn"); b.innerText = "Saving...";
        const d = { name: document.getElementById('p-name').value, nickname: document.getElementById('p-nickname').value, bio: document.getElementById('p-bio').value, country: document.getElementById('p-country').value, themeColor: document.getElementById('p-theme').value };
        if (finalProfilePic) d.pic = await uploadToCloudinary(finalProfilePic);
        if (finalCoverPic) d.coverPic = await uploadToCloudinary(finalCoverPic);
        await setDoc(doc(db, "users", currentUser.uid), d, { merge: true });
        
        // Batch Update Posts
        const q = query(postsRef, where("uid", "==", currentUser.uid));
        const s = await getDocs(q);
        s.forEach(async doc => await updateDoc(doc.ref, { username: d.name, userPic: d.pic }));
        
        applyTheme(d.themeColor); b.innerText = "‚úÖ Saved"; setTimeout(() => b.innerText = "üíæ Save Changes", 2000); 
    });

    // Helpers
    window.switchTab=(t)=>{document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));document.getElementById('tab-'+t).classList.remove('hidden');document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('nav-active'));if(t==='home')document.querySelectorAll('.nav-item')[0].classList.add('nav-active');if(t==='news'){document.querySelectorAll('.nav-item')[1].classList.add('nav-active'); loadNews();}if(t==='chats')document.querySelectorAll('.nav-item')[2].classList.add('nav-active');if(t==='search')document.querySelectorAll('.nav-item')[3].classList.add('nav-active');if(t==='notifs')document.querySelectorAll('.nav-item')[4].classList.add('nav-active');if(t==='profile')document.querySelectorAll('.nav-item')[5].classList.add('nav-active');};
    window.startChat=async(tid)=>{const q=query(collection(db,"chats"),where("participants","array-contains",currentUser.uid));const s=await getDocs(q);let eid=null;s.forEach(d=>{if(d.data().participants.includes(tid))eid=d.id});if(eid)openChatWindow(eid,tid);else{const d=await addDoc(collection(db,"chats"),{participants:[currentUser.uid,tid],lastMessage:"",lastUpdated:serverTimestamp(),isRead:true,lastSenderId:currentUser.uid});openChatWindow(d.id,tid)}};
    window.openChatWindow=async(cid,tid)=>{currentChatId=cid;document.getElementById("chat-room").classList.remove("hidden");const u=await getDoc(doc(db,"users",tid));if(u.exists())document.getElementById("chat-with-name").innerText=u.data().name;onSnapshot(query(collection(db,"chats",cid,"messages"),orderBy("createdAt","asc")),s=>{const d=document.getElementById("chat-messages");d.innerHTML="";s.forEach(o=>{const m=o.data();const e=document.createElement("div");e.className=`message-bubble ${m.senderId===currentUser.uid?'msg-me':'msg-them'}`;e.innerText=m.text;d.appendChild(e)});d.scrollTop=d.scrollHeight})};
    window.sendMessage=async()=>{const i=document.getElementById("msg-input");if(i.value&&currentChatId){await addDoc(collection(db,"chats",currentChatId,"messages"),{text:i.value,senderId:currentUser.uid,createdAt:serverTimestamp()});await updateDoc(doc(db,"chats",currentChatId),{lastMessage:i.value,lastUpdated:serverTimestamp(),isRead:false,lastSenderId:currentUser.uid});i.value=""}};
    window.closeChat=()=>{document.getElementById("chat-room").classList.add("hidden");currentChatId=null};
    window.goBack=()=>window.switchTab('home'); window.logout=()=>signOut(auth);
    window.closePostView = () => document.getElementById('post-view-overlay').classList.add('hidden');
    window.openSinglePost = async (pid) => { document.getElementById('post-view-overlay').classList.remove('hidden'); const d = await getDoc(doc(db,"posts",pid)); if(d.exists()) document.getElementById('single-post-content').innerHTML = getPostHTML(pid,d.data(),'-view'); };

    // Search & Auth
    document.getElementById("searchInput").addEventListener("input",async(e)=>{const t=e.target.value.toLowerCase();const r=document.getElementById("searchResults");r.innerHTML="";if(t.length<2)return;const s=await getDocs(collection(db,"users"));s.forEach(d=>{const u=d.data();if(u.name?.toLowerCase().includes(t)){const e=document.createElement("div");e.className="user-result";e.onclick=()=>openUserProfile(d.id);e.innerHTML=`<div class="avatar" style="background-image:url('${u.pic||''}')"></div><div style="color:#fff;">${u.name}</div>`;r.appendChild(e)}})});
    document.getElementById("auth-action-btn").addEventListener("click",()=>{const e=document.getElementById("email").value;const p=document.getElementById("password").value;if(document.getElementById("auth-action-btn").innerText.includes("Enter"))signInWithEmailAndPassword(auth,e,p).catch(alert);else createUserWithEmailAndPassword(auth,e,p).catch(alert)});
    document.getElementById("toggle-auth-btn").addEventListener("click",function(){const s=this.innerText.includes("Create");this.innerText=s?"Have an account? Login":"New here? Create Account";document.getElementById("auth-action-btn").innerText=s?"Sign Up":"Enter Network"});

    // Voice
    let mediaRecorder; let audioChunks = []; let activeRecordingId = null;
    window.toggleVoiceRecording = async (postId) => { const btn=document.getElementById(`mic-btn-${postId}`); const st=document.getElementById(`mic-status-${postId}`); if(activeRecordingId===postId && mediaRecorder?.state==="recording"){ mediaRecorder.stop(); btn.style.color=""; st.innerText="Sending..."; activeRecordingId=null; return; } if(activeRecordingId){alert("Already recording!");return;} try{ const stream=await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder=new MediaRecorder(stream); audioChunks=[]; activeRecordingId=postId; btn.style.color="red"; st.innerText="Recording..."; mediaRecorder.ondataavailable=e=>audioChunks.push(e.data); mediaRecorder.onstop=async()=>{ const blob=new Blob(audioChunks,{type:'audio/webm'}); const url=URL.createObjectURL(blob); await updateDoc(doc(db,"posts",postId),{voiceNotes:arrayUnion({url:url,name:currentUserName})}); st.innerText="Voice"; }; mediaRecorder.start(); }catch(e){alert("Mic Error");} };
    
    // Profile Viewer (Fixed)
    let profileUnsub = null;
    window.openUserProfile = async (uid) => { 
        if(!uid) return; 
        currentUserViewing = uid; 
        window.switchTab('user-view'); 
        window.switchProfileTab('posts');

        if (profileUnsub) profileUnsub();

        const isMe = (uid === currentUser.uid);
        const msgBtn = document.getElementById("message-user-btn");
        const frndBtn = document.getElementById("friend-user-btn");

        if (isMe) {
            msgBtn.style.display = "none";
            frndBtn.style.display = "none";
        } else {
            msgBtn.style.display = "inline-block"; 
            frndBtn.style.display = "inline-block";
            msgBtn.onclick = () => startChat(uid); 
            frndBtn.onclick = () => toggleFriend(uid);
        }

        document.getElementById("view-name").innerText="Loading..."; 
        document.getElementById("view-pic").style.backgroundImage="none";
        
        if(friendListener) friendListener(); 
        if (!isMe) {
            friendListener = onSnapshot(doc(db,"users",currentUser.uid),(doc)=>{
                if(doc.exists()){
                    const me=doc.data(); 
                    const btn=document.getElementById("friend-user-btn"); 
                    if(me.friends?.includes(uid)){btn.innerText="Friends";btn.className="friend-btn friends"}
                    else if(me.requestsSent?.includes(uid)){btn.innerText="Request Sent";btn.className="friend-btn requested"}
                    else if(me.requestsReceived?.includes(uid)){btn.innerText="Accept Request";btn.className="friend-btn accept"}
                    else{btn.innerText="Add Friend";btn.className="friend-btn add"}
                }
            });
        }

        const d=await getDoc(doc(db,"users",uid)); 
        if(d.exists()){
            const u=d.data(); 
            document.getElementById("view-name").innerText=u.name; 
            document.getElementById("view-nick").innerText=u.nickname; 
            document.getElementById("view-bio").innerText=u.bio; 
            document.getElementById("view-country").innerText="üè≥Ô∏è "+(u.country||"Earth"); 
            if(u.pic)document.getElementById("view-pic").style.backgroundImage=`url('${u.pic}')`; 
            if(u.coverPic)document.getElementById("view-cover").style.backgroundImage=`url('${u.coverPic}')`; 
            const c = u.themeColor || "#bf00ff";
            document.getElementById('view-cover').style.borderBottomColor = c; 
            document.getElementById('view-nick').style.color = c; 
            document.getElementById('message-user-btn').style.background = c;
        }

        const p = document.getElementById("user-posts-feed"); 
        p.innerHTML = "<div style='padding:20px; text-align:center;'>Loading posts...</div>"; 
        
        const q = query(postsRef); 
        profileUnsub = onSnapshot(q, (snapshot) => {
            p.innerHTML = ""; 
            let count = 0; 
            let allPosts = [];
            snapshot.forEach(docSnap => {
                const x = docSnap.data();
                const id = docSnap.id;
                if(x.uid === uid || x.author === uid || x.userId === uid || x.user === uid){
                    allPosts.push({id: id, data: x});
                }
            }); 
            
            allPosts.sort((a, b) => {
                const timeA = a.data.createdAt ? a.data.createdAt.toMillis() : 0;
                const timeB = b.data.createdAt ? b.data.createdAt.toMillis() : 0;
                return timeB - timeA;
            });

            allPosts.forEach(post => {
                count++;
                const e = document.createElement("div");
                e.className = "post";
                e.id = `profile-post-${post.id}`;
                e.innerHTML = getPostHTML(post.id, post.data, '-profile'); 
                p.appendChild(e);
            });

            if(count === 0) p.innerHTML = "<div style='text-align:center;padding:20px;color:#888;'>No posts found for this user.</div>";
        });
    };
    
    window.switchProfileTab = (tab) => {
        document.querySelectorAll('.p-tab-btn').forEach(b => b.classList.remove('p-tab-active'));
        document.getElementById('pt-'+tab).classList.add('p-tab-active');
        document.querySelectorAll('.p-content-box').forEach(b => b.classList.add('hidden'));
        if(tab === 'posts') document.getElementById('user-posts-feed').classList.remove('hidden');
        if(tab === 'images') { document.getElementById('user-images-feed').classList.remove('hidden'); loadUserMedia(currentUserViewing); }
        if(tab === 'friends') { document.getElementById('user-friends-list').classList.remove('hidden'); loadUserFriends(currentUserViewing); }
    };
    
    window.toggleFriend=async(tid)=>{ const my=doc(db,"users",currentUser.uid); const tr=doc(db,"users",tid); const s=document.getElementById("friend-user-btn").innerText; if(s==="Add Friend"){await updateDoc(my,{requestsSent:arrayUnion(tid)});await updateDoc(tr,{requestsReceived:arrayUnion(currentUser.uid)}); createNotification(tid, 'friend_req', null); }else if(s==="Accept Request"){await updateDoc(my,{friends:arrayUnion(tid),requestsReceived:arrayRemove(tid)});await updateDoc(tr,{friends:arrayUnion(currentUser.uid),requestsSent:arrayRemove(currentUser.uid)}); createNotification(tid, 'friend_accept', null); } };
    async function loadUserFriends(uid){const c=document.getElementById('user-friends-list'); c.innerHTML="Loading..."; const u=await getDoc(doc(db,"users",uid)); const f=u.data().friends||[]; c.innerHTML=""; if(f.length===0)c.innerHTML="No friends."; for(const fid of f){const fd=await getDoc(doc(db,"users",fid)); if(fd.exists()){const ff=fd.data(); const d=document.createElement("div"); d.className="friend-item"; d.innerHTML=`<div class="avatar" style="background-image:url('${ff.pic||''}')"></div><div style="flex:1;margin-left:10px;color:#fff;"><b>${ff.name}</b></div><button class="btn" style="color:var(--app-color);" onclick="openUserProfile('${fid}')">View</button>`; c.appendChild(d);}}}
    async function loadUserMedia(uid) { const container = document.getElementById('user-images-feed'); container.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:20px;color:#555;'>Loading...</div>"; const s = await getDocs(query(postsRef, orderBy("createdAt", "desc"))); container.innerHTML = ""; let count = 0; s.forEach(d => { const x = d.data(); if(x.uid === uid && (x.imageUrl || x.videoUrl)) { count++; if(x.imageUrl) { const i=document.createElement("img"); i.className="grid-img"; i.src=x.imageUrl; i.onclick=()=>window.open(x.imageUrl,'_blank'); container.appendChild(i); } else if(x.videoUrl) { const v=document.createElement("div"); v.className="grid-img"; v.style.display="flex"; v.style.alignItems="center"; v.style.justifyContent="center"; v.innerHTML="üìπ"; v.onclick=()=>window.open(x.videoUrl,'_blank'); container.appendChild(v); } }}); if(count === 0) container.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:20px;color:#555;'>No media shared.</div>"; }
    window.loadNews = async () => { const feed = document.getElementById('news-feed'); feed.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">üì° AI Scanning Global Frequencies...</div>'; try { const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://feeds.bbci.co.uk/news/world/rss.xml'); const data = await res.json(); if(data.status !== 'ok') throw new Error('Signal lost'); feed.innerHTML = ''; data.items.forEach(item => { let tag = "General"; const txt = item.title + item.description; if(txt.match(/war|conflict|attack|military/i)) tag = "Conflict"; else if(txt.match(/tech|ai|cyber|data/i)) tag = "Technology"; else if(txt.match(/money|market|economy/i)) tag = "Finance"; else if(txt.match(/climate|storm|earth/i)) tag = "Environment"; else if(txt.match(/politics|election|law/i)) tag = "Politics"; const card = document.createElement('div'); card.className = 'news-card'; card.innerHTML = `<img src="${item.thumbnail || 'https://refivenine.github.io/Evtx/logo.png'}" class="news-img" onerror="this.style.display='none'"><div class="news-content"><span class="news-ai-tag">${tag}</span><h4 class="news-title"><a href="${item.link}" target="_blank" style="color:#fff;text-decoration:none;">${item.title}</a></h4><div class="news-desc">${item.description.replace(/<[^>]*>?/gm, '')}</div><div class="news-meta"><span>Source: BBC World</span><span>${item.pubDate.split(' ')[0]}</span></div></div>`; feed.appendChild(card); }); } catch(e) { feed.innerHTML = '<div style="padding:20px;text-align:center;color:#cc0000;">‚ö†Ô∏è Uplink Failed. Retrying...</div>'; } };
</script>
</body>
</html>
