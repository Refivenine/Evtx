<!DOCTYPE html>
<html>
<head>
    <title>EVTX | Network</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#bf00ff">
    <link rel="apple-touch-icon" href="https://refivenine.github.io/Evtx/logo.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* --- DESIGN ENGINE --- */
        :root { --app-color: #bf00ff; }
        body {
            background: linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.90)), url('https://refivenine.github.io/cover2.jpg');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; padding-bottom: 80px;
            overscroll-behavior: none;
        }
        .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .hidden { display: none !important; }
        .btn { border: none; outline: none; cursor: pointer; background: none; }

        /* SPLASH */
        #splash-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .pulse-logo { font-weight: 900; color: #fff; font-size: 40px; letter-spacing: 2px; animation: pulse 1.5s infinite; }
        .pulse-logo span { color: var(--app-color); }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }

        /* FRIEND BUTTON */
        .friend-btn {
            background: #333; color: #fff; padding: 8px 20px; border-radius: 20px; font-size: 13px;
            font-weight: bold; margin-right: 10px; transition: 0.2s; border: 1px solid #444; cursor: pointer;
        }
        .friend-btn.add { background: var(--app-color); border-color: var(--app-color); }
        .friend-btn.requested { background: #222; color: #888; }
        .friend-btn.accept { background: #00c853; border-color: #00c853; }
        .friend-btn.friends { background: #111; color: var(--app-color); border-color: var(--app-color); }

        /* NOTIFICATIONS */
        .notif-item {
            display: flex; align-items: center; background: #151515; padding: 15px;
            border-bottom: 1px solid #222; cursor: pointer; transition: background 0.1s;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .notif-item:active { background: #2a2a2a; transform: scale(0.99); }
        .notif-item.unread { background: #1a1a2e; border-left: 3px solid var(--app-color); }
        .notif-icon { margin-right: 15px; color: var(--app-color); font-size: 20px; }
        .notif-text { font-size: 14px; color: #ddd; flex: 1; pointer-events: none; }

        /* BADGES */
        .nav-item { position: relative; color: #555; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-active { color: var(--app-color); }
        .badge {
            position: absolute; top: -5px; right: -5px; background: #ff0000; color: #fff;
            font-size: 10px; font-weight: 900; min-width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; border: 2px solid #000;
            z-index: 10; display: none;
        }

        /* CROPPER */
        #cropper-modal { position: fixed; inset: 0; background: #000; z-index: 6000; display: flex; flex-direction: column; }
        .crop-area { flex: 1; min-height: 0; position: relative; background: #111; overflow: hidden; }
        .crop-controls { flex-shrink: 0; height: 70px; background: #151515; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        #image-to-crop { max-width: 100%; display: block; }

        /* AUTH */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .auth-box { background: #151515; padding: 30px; border-radius: 20px; border: 1px solid var(--app-color); width: 85%; max-width: 350px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; box-sizing: border-box; }
        .main-btn { width: 100%; padding: 12px; background: var(--app-color); color: #fff; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; border: none; }

        /* HEADER */
        .header { background: rgba(10, 10, 10, 0.95); padding: 15px; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; }
        .logo { font-weight: 900; color: #fff; font-size: 22px; letter-spacing: 1px; }
        .logo span { color: var(--app-color); }
        .container { max-width: 600px; margin: 0 auto; padding: 0; }

        /* CHAT */
        .chat-list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; background: #151515; transition: 0.2s; }
        .chat-list-item.unread-chat { background: #1a1a2e; border-left: 3px solid var(--app-color); }
        .chat-preview { margin-left: 15px; flex: 1; }
        .chat-name { font-weight: bold; color: #fff; margin: 0; }
        .chat-last-msg { color: #777; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-dot { width: 8px; height: 8px; background: var(--app-color); border-radius: 50%; margin-left: 10px; display: none; }
        #chat-room { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; }
        .chat-header { padding: 15px; background: #151515; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 20px; font-size: 14px; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: var(--app-color); color: #fff; border-bottom-right-radius: 2px; }
        .msg-them { align-self: flex-start; background: #222; color: #ddd; border-bottom-left-radius: 2px; }
        .chat-input-area { padding: 15px; background: #151515; border-top: 1px solid #333; display: flex; gap: 10px; padding-bottom: max(15px, env(safe-area-inset-bottom)); }

        /* POSTS & FEED */
        .create-box { background: #151515; padding: 15px; border-radius: 12px; border: 1px solid #333; margin: 15px; margin-bottom: 25px; }
        textarea#postInput { width: 100%; background: #080808; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 10px; resize: none; box-sizing: border-box; outline: none; }
        .post { background: #151515; border-radius: 15px; padding: 15px; margin: 15px; margin-bottom: 15px; border: 1px solid #222; }
        .user-header { display: flex; align-items: center; margin-bottom: 12px; }
        .avatar { width: 40px; height: 40px; background: #333; border-radius: 50%; margin-right: 12px; border: 2px solid #333; background-size: cover; background-position: center; display: block; }
        .user-meta h4 { margin: 0; color: #fff; font-size: 15px; cursor: pointer; }
        .user-meta span { font-size: 12px; color: #777; }
        .content { font-size: 15px; line-height: 1.5; color: #ddd; margin-bottom: 10px; white-space: pre-wrap; }
        .post-img { width: 100%; border-radius: 12px; margin-top: 5px; border: 1px solid #333; }
        .actions { border-top: 1px solid #222; padding-top: 12px; margin-top: 10px; display: flex; justify-content: space-between; padding-right: 10px; }
        .act-btn { background: none; color: #888; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .act-btn:hover { color: var(--app-color); }
        .liked { color: #e0245e !important; }
        .liked svg { fill: #e0245e; stroke: none; }
        .comments-section { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; }
        .comment-input-row { display: flex; gap: 10px; margin-top: 10px; }
        .mini-input { width: 100%; background: #000; border: 1px solid #333; padding: 8px; border-radius: 20px; color: #fff; outline: none; }
        .mini-btn { background: #333; color: #fff; border-radius: 20px; padding: 5px 15px; font-size: 12px; }
        .single-comment { font-size: 13px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #222; }
        .c-user { color: var(--app-color); font-weight: bold; margin-right: 5px; }
        #edit-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .edit-modal { background: #1a1a1a; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; border: 1px solid #333; }

        /* PROFILE LAYOUTS */
        .profile-container { background: #151515; border-radius: 0 0 20px 20px; overflow: hidden; border: 1px solid #333; border-top: none; margin-bottom: 20px; }
        .cover-photo-container { position: relative; width: 100%; height: 180px; background: #222; background-size: cover; background-position: center; border-bottom: 3px solid var(--app-color); }
        .big-avatar { width: 110px; height: 110px; border-radius: 50%; border: 4px solid #151515; background-size: cover; background-position: center; background-color: #333; position: absolute; }
        .edit-cover-btn { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .profile-header-overlap { position: relative; margin-bottom: 60px; }
        .edit-pic-btn { position: absolute; bottom: -50px; left: 50%; transform: translateX(35px); z-index: 11; background: var(--app-color); color: #fff; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #151515; }
        .form-section { padding: 20px; padding-top: 0; }
        .form-label { color: var(--app-color); font-size: 12px; margin-top: 20px; display: block; font-weight: 700; letter-spacing: 1px; }
        .form-input { width: 100%; background: #080808; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; box-sizing: border-box; }
        .form-input:focus { border-color: var(--app-color); outline: none; }
        .color-picker-wrapper { display: flex; align-items: center; gap: 15px; background: #080808; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        input[type="color"] { -webkit-appearance: none; border: none; width: 40px; height: 40px; border-radius: 50%; overflow: hidden; padding: 0; margin: 0; cursor: pointer; }

        .public-bio-box { text-align: center; padding: 0 20px 20px 20px; }
        .public-name { font-size: 22px; font-weight: bold; margin: 0; color: #fff; display: block; min-height: 30px; }
        .public-nick { color: var(--app-color); font-size: 14px; margin-bottom: 10px; display: block; min-height: 20px; }
        .public-stats { display: flex; justify-content: center; gap: 15px; margin-top: 15px; color: #777; font-size: 13px; }
        .stat-tag { background: #222; padding: 4px 10px; border-radius: 10px; border: 1px solid #333; }
        .back-btn-float { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); color: #fff; padding: 8px 12px; border-radius: 20px; backdrop-filter: blur(5px); z-index: 20; }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; padding: 12px 0; z-index: 2000; }
        .search-bar { width: 90%; margin: 15px auto; display:block; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 30px; outline: none; box-sizing: border-box; }
        .user-result { display: flex; align-items: center; background: #1a1a1a; padding: 10px; border-radius: 15px; margin: 10px 15px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="splash-screen"><div class="pulse-logo">EV<span>TX</span></div><div style="color:#777; margin-top:10px; font-size:12px;">ESTABLISHING UPLINK...</div></div>
    
    <div id="auth-screen" class="hidden"><div class="logo" style="margin-bottom: 20px; font-size: 40px;">EV<span>TX</span></div><div class="auth-box"><h2 id="auth-title" style="color:#fff;">Login</h2><input type="email" id="email" class="auth-input" placeholder="Email"><input type="password" id="password" class="auth-input" placeholder="Password"><button id="auth-action-btn" class="main-btn">Login</button><p id="toggle-auth-btn" style="color:#777; font-size:12px; margin-top:15px; cursor:pointer;">New here? Create Account</p></div></div>

    <div id="cropper-modal" class="hidden"><div class="crop-area"><img id="image-to-crop" src=""></div><div class="crop-controls"><button onclick="cancelCrop()" class="btn" style="color:#ddd">Cancel</button><button onclick="performCrop()" class="btn" style="color:var(--app-color); font-weight:bold;">Done</button></div></div>

    <div id="app-screen" class="hidden">
        <div class="header"><div class="logo">EV<span>TX</span></div><button onclick="logout()" class="btn" style="color:#777; font-size:12px;">Log Out</button></div>
        <div id="chat-room" class="hidden"><div class="chat-header"><button onclick="closeChat()" class="btn" style="color:#fff;">&#10094;</button><div id="chat-with-pic" class="avatar" style="width:30px;height:30px;"></div><h4 id="chat-with-name" style="color:#fff; margin:0;">User</h4></div><div id="chat-msgs" class="chat-messages"></div><div class="chat-input-area"><input id="msg-input" class="mini-input" placeholder="Message..."><button onclick="sendMessage()" class="mini-btn">Send</button></div></div>

        <div id="edit-overlay" class="hidden"><div class="edit-modal"><h3 style="color:var(--app-color); margin-top:0;">&#9999;&#65039; Edit Post</h3><textarea id="edit-text-input" class="form-input" rows="4"></textarea><div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;"><button onclick="closeEditMode()" class="btn" style="color:#777;">Cancel</button><button onclick="saveEditedPost()" class="main-btn" style="width:auto;">Save</button></div></div></div>

        <div class="container">
            <div id="tab-home" class="tab-content">
                <div class="create-box">
                    <textarea id="postInput" rows="2" placeholder="What is happening?"></textarea>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <label for="fileInput" style="cursor:pointer;"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></label>
                        <input type="file" id="fileInput" hidden accept="image/*">
                        <button id="sendBtn" class="main-btn" style="width:auto; padding:8px 25px; margin:0;">Post</button>
                    </div>
                    <div id="filePreview" style="color:var(--app-color); font-size:12px; margin-top:5px;"></div>
                </div>
                <div id="feed"></div>
            </div>

            <div id="tab-chats" class="tab-content hidden"><h3 style="padding:15px; margin:0; border-bottom:1px solid #222;">Messages</h3><div id="chat-list"></div></div>
            
            <div id="tab-search" class="tab-content hidden"><input type="text" id="searchInput" class="search-bar" placeholder="&#128269; Search users..."><div id="searchResults"></div></div>
            
            <div id="tab-notifs" class="tab-content hidden"><h3 style="padding:15px; margin:0; border-bottom:1px solid #222;">Activity</h3><div id="notif-list"></div></div>

            <div id="tab-profile" class="tab-content hidden">
                <div class="profile-container">
                    <div class="profile-header-overlap">
                        <div id="my-cover-pic" class="cover-photo-container">
                             <label for="coverPicInput" class="edit-cover-btn"><svg class="icon" style="width:14px;height:14px;" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg> Change Cover</label>
                             <input type="file" id="coverPicInput" hidden accept="image/*">
                        </div>
                        <div style="position:absolute; bottom:-55px; left:50%; transform:translateX(-50%);">
                            <div id="my-pic" class="big-avatar"></div>
                            <label for="profilePicInput" class="edit-pic-btn"><svg class="icon" style="width:16px;height:16px;" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></label>
                            <input type="file" id="profilePicInput" hidden accept="image/*">
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <label class="form-label">AURA COLOR</label>
                        <div class="color-picker-wrapper">
                             <input type="color" id="themeColor" value="#bf00ff" onchange="applyTheme(this.value)">
                             <span style="font-size:13px; color:#777;">Pick a color that represents you.</span>
                        </div>

                        <label class="form-label">DISPLAY NAME</label>
                        <input id="p-name" class="form-input" placeholder="Your Name">

                        <label class="form-label">NICKNAME</label>
                        <input id="p-nickname" class="form-input" placeholder="@nickname">

                        <label class="form-label">BIO</label>
                        <textarea id="p-bio" class="form-input" rows="3" placeholder="Tell us about yourself..."></textarea>

                        <button id="saveProfileBtn" class="main-btn" style="margin-top:25px;">Save Profile</button>
                    </div>
                </div>
            </div>

            <div id="tab-user-view" class="tab-content hidden">
                <div class="profile-container">
                    <div class="cover-photo-container" id="view-cover">
                        <button onclick="goBack()" class="back-btn-float">&#10094; Back</button>
                    </div>
                    <div style="position:relative; height:60px;">
                         <div id="view-pic" class="big-avatar" style="bottom:10px; left:50%; transform:translateX(-50%); border-color:#151515;"></div>
                    </div>
                    <div class="public-bio-box">
                        <div id="view-name" class="public-name">User</div>
                        <div id="view-nick" class="public-nick">@user</div>
                        <div id="view-bio" style="color:#ddd; font-size:14px; margin-top:10px;"></div>
                        <div class="public-stats">
                             <span id="view-country" class="stat-tag">Earth</span>
                        </div>
                        <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                            <button id="message-user-btn" class="main-btn" style="width:auto; padding:8px 20px; font-size:14px;">&#128172; Message</button>
                            <button id="friend-user-btn" class="friend-btn">Add Friend</button>
                        </div>
                    </div>
                </div>
                <div id="user-posts-feed"></div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item nav-active" onclick="switchTab('home')"><svg class="icon" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 0 0 1 1h3m10-11l2 2m-2-2v10a1 1 0 0 1-1 1h-3m-6 0a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1m-6 0h6"/></svg></div>
            <div class="nav-item" onclick="switchTab('chats')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                <div id="chat-badge" class="badge">0</div>
            </div>
            <div class="nav-item" onclick="switchTab('search')"><svg class="icon" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"/></svg></div>
            <div class="nav-item" onclick="switchTab('notifs')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                <div id="notif-badge" class="badge">0</div>
            </div>
            <div class="nav-item" onclick="switchTab('profile')"><svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, where, onSnapshot, serverTimestamp, updateDoc, doc, increment, deleteDoc, setDoc, getDoc, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const ADMIN_EMAIL = "hrangategamer@gmail.com";
        const firebaseConfig = { apiKey: "AIzaSyAiakBfUC4QScczQq6wARW7KC0-gKcomg8", authDomain: "evtx-social.firebaseapp.com", projectId: "evtx-social", storageBucket: "evtx-social.firebaseapp.com", messagingSenderId: "542777804477", appId: "1:542777804477:web:2a30d55e7178c714341b6c" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const postsRef = collection(db, "posts");
        let currentUser = null; let currentEditPostId = null; let previousTab = 'home'; let currentUserName = "User"; let currentChatId = null;
        let cropper = null; let cropTarget = null; let finalPostImage = null; let finalProfilePic = null; let finalCoverPic = null;
        let friendListener = null;

        const applyTheme = (color) => { const c = color || "#bf00ff"; document.documentElement.style.setProperty('--app-color', c); };
        const applyUserViewTheme = (color) => { const c = color || "#bf00ff"; document.getElementById('view-cover').style.borderBottomColor = c; document.getElementById('view-nick').style.color = c; };

        onAuthStateChanged(auth, async (user) => {
            const splash = document.getElementById("splash-screen");
            if (user) {
                currentUser = user; document.getElementById("auth-screen").classList.add("hidden"); document.getElementById("app-screen").classList.remove("hidden");
                loadFeed(); listenForNotifications(); loadChatList(); listenForChatBadges();
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if(uDoc.exists()) {
                    const d = uDoc.data(); currentUserName = d.name || user.email.split('@')[0]; applyTheme(d.themeColor);
                    document.getElementById('p-name').value = d.name || ""; document.getElementById('p-nickname').value = d.nickname || ""; document.getElementById('p-bio').value = d.bio || "";
                    if(d.pic) document.getElementById('my-pic').style.backgroundImage = `url('${d.pic}')`; if(d.coverPic) document.getElementById('my-cover-pic').style.backgroundImage = `url('${d.coverPic}')`;
                }
            } else { document.getElementById("auth-screen").classList.remove("hidden"); document.getElementById("app-screen").classList.add("hidden"); }
            setTimeout(() => { splash.style.opacity = "0"; setTimeout(() => splash.style.display = "none", 500); }, 1000);
        });

        // --- BADGES ---
        function listenForChatBadges() {
            const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
            onSnapshot(q, (sn) => {
                let unreadCount = 0;
                sn.forEach(d => { const data = d.data(); if (data.lastSenderId && data.lastSenderId !== currentUser.uid && data.isRead === false) unreadCount++; });
                const badge = document.getElementById("chat-badge");
                if(unreadCount > 0) { badge.style.display = "flex"; badge.innerText = unreadCount; } else { badge.style.display = "none"; }
            });
        }

        // --- CROPPER ---
        function initCrop(file, target) { const reader = new FileReader(); reader.onload = (e) => { const img = document.getElementById('image-to-crop'); img.src = e.target.result; document.getElementById('cropper-modal').classList.remove('hidden'); if(cropper) cropper.destroy(); cropper = new Cropper(img, { aspectRatio: target === 'cover' ? 16/9 : 1, viewMode: 1 }); cropTarget = target; }; reader.readAsDataURL(file); }
        window.performCrop = () => { if(!cropper) return; const canvas = cropper.getCroppedCanvas({ maxWidth: 800, maxHeight: 800 }); const url = canvas.toDataURL('image/jpeg', 0.8); if(cropTarget==='post') { finalPostImage=url; document.getElementById('filePreview').innerText="Image ready"; } else if(cropTarget==='pic') { finalProfilePic=url; updateDoc(doc(db,"users",currentUser.uid),{pic:url}); document.getElementById('my-pic').style.backgroundImage=`url('${url}')`; } else if(cropTarget==='cover') { finalCoverPic=url; updateDoc(doc(db,"users",currentUser.uid),{coverPic:url}); document.getElementById('my-cover-pic').style.backgroundImage=`url('${url}')`; } window.cancelCrop(); };
        window.cancelCrop = () => { document.getElementById('cropper-modal').classList.add('hidden'); if(cropper) { cropper.destroy(); cropper = null; } document.getElementById('fileInput').value=""; };
        document.getElementById("fileInput").addEventListener('change', function() { if(this.files[0]) initCrop(this.files[0], 'post'); });
        document.getElementById("profilePicInput").addEventListener('change', function() { if(this.files[0]) initCrop(this.files[0], 'pic'); });
        document.getElementById("coverPicInput").addEventListener('change', function() { if(this.files[0]) initCrop(this.files[0], 'cover'); });

        // --- CORE SAVE PROFILE (IMPROVED) ---
        document.getElementById("saveProfileBtn").addEventListener("click", async () => {
            const btn = document.getElementById("saveProfileBtn");
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            const newName = document.getElementById("p-name").value;
            const newNick = document.getElementById("p-nickname").value;
            const newBio = document.getElementById("p-bio").value;
            const newColor = document.getElementById("themeColor").value;

            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { name: newName, nickname: newNick, bio: newBio, themeColor: newColor });
                
                // INSTANT DOM UPDATE
                const oldName = currentUserName;
                currentUserName = newName;
                applyTheme(newColor);
                
                // Fix names on existing posts in the Feed immediately
                document.querySelectorAll('.user-meta h4').forEach(header => {
                    if (header.innerText.trim() === oldName.trim()) { header.innerText = newName; }
                });

                alert("Profile Saved!");
            } catch (error) { console.error(error); alert("Error saving profile."); }
            btn.innerText = originalText;
        });

        document.getElementById("sendBtn").addEventListener("click", async () => { const i=document.getElementById("postInput"); if(!i.value && !finalPostImage)return; document.getElementById("sendBtn").innerText="..."; const t=i.value; const url=finalPostImage; try { await addDoc(collection(db,"posts"),{ text:t, imageUrl:url, uid:currentUser.uid, name:currentUserName, createdAt:serverTimestamp(), likes:[], shareCount:0 }); i.value=""; finalPostImage=null; document.getElementById('filePreview').innerText=""; alert("Posted!"); } catch(e){ console.error(e); } document.getElementById("sendBtn").innerText="Post"; });

        // --- CHAT ---
        window.startChat = async (tid) => { if(tid===currentUser.uid)return alert("Cannot msg yourself."); const q=query(collection(db,"chats"),where("participants","array-contains",currentUser.uid)); const sn = await getDocs(q); let cid = null; sn.forEach(d=>{ const da=d.data(); if(da.participants.includes(tid)) cid=d.id; }); if(!cid){ const n = await addDoc(collection(db,"chats"),{ participants:[currentUser.uid, tid], lastMsg:"", lastSenderId:currentUser.uid, isRead:true, updatedAt:serverTimestamp() }); cid=n.id; } window.openChatWindow(cid, tid); };
        window.openChatWindow = async (cid, tid) => { currentChatId=cid; document.getElementById("chat-room").classList.remove("hidden"); const chatDoc = await getDoc(doc(db, "chats", cid)); if(chatDoc.exists()){ const msgsRef = collection(db, "chats", cid, "messages"); const q = query(msgsRef, orderBy("createdAt", "asc")); onSnapshot(q, (sn)=>{ const d=document.getElementById("chat-msgs"); d.innerHTML=""; sn.forEach(m=>{ const md=m.data(); const b=document.createElement("div"); b.className=`message-bubble ${md.senderId===currentUser.uid?'msg-me':'msg-them'}`; b.innerText=md.text; d.appendChild(b); }); d.scrollTop=d.scrollHeight; }); updateDoc(doc(db,"chats",cid),{isRead:true}); } };
        window.sendMessage = async () => { const i=document.getElementById("msg-input"); const t=i.value.trim(); if(!t || !currentChatId)return; i.value=""; await addDoc(collection(db,"chats",currentChatId,"messages"),{ text:t, senderId:currentUser.uid, createdAt:serverTimestamp() }); await updateDoc(doc(db,"chats",currentChatId),{ lastMsg:t, lastSenderId:currentUser.uid, isRead:false, updatedAt:serverTimestamp() }); };
        window.closeChat = () => { document.getElementById("chat-room").classList.add("hidden"); currentChatId=null; };
        function loadChatList() { const q=query(collection(db,"chats"),where("participants","array-contains",currentUser.uid)); onSnapshot(q,async(s)=>{const l=document.getElementById("chat-list");l.innerHTML=""; s.forEach(async d=>{ const da=d.data(); const oid = da.participants.find(id=>id!==currentUser.uid); const u = await getDoc(doc(db,"users",oid)); const ud=u.data(); const div=document.createElement("div"); div.className=`chat-list-item ${da.lastSenderId!==currentUser.uid && !da.isRead ? 'unread-chat':''}`; div.onclick=()=>window.openChatWindow(d.id, oid); div.innerHTML=`<div class="avatar" style="background-image:url('${ud.pic||''}')"></div><div class="chat-preview"><h4 class="chat-name">${ud.name}</h4><div class="chat-last-msg">${da.lastSenderId===currentUser.uid?'You: ':''}${da.lastMsg}</div></div>`; l.appendChild(div); }); }); }

        // --- NOTIFS ---
        function listenForNotifications() {
            const q=query(collection(db,"notifications"),where("recipient","==",currentUser.uid));
            onSnapshot(q,(s)=>{
                const l=document.getElementById("notif-list");l.innerHTML="";let n=[];let u=0;
                s.forEach(d=>{const x=d.data();x.id=d.id;n.push(x);if(!x.read)u++});
                n.sort((a,b)=>(b.time?.seconds||0)-(a.time?.seconds||0));
                if(n.length===0)l.innerHTML="<div style='text-align:center;padding:20px;color:#555;'>No notifications</div>";
                else n.forEach(x=>{
                    const e=document.createElement("div");e.className=`notif-item ${!x.read?'unread':''}`;
                    let i="üîî";if(x.type==='like')i="‚ù§Ô∏è";if(x.type==='comment')i="üí¨";if(x.type==='share')i="üîÅ";if(x.type==='friend_req')i="üë•";
                    e.innerHTML=`<div class="notif-icon">${i}</div><div class="notif-text"><b>${x.sender}</b> ${x.text}</div>`;
                    e.addEventListener('click', async () => { 
                         if(x.senderUid) { await window.openUserProfile(x.senderUid); }
                         updateDoc(doc(db,"notifications",x.id),{read:true});
                    });
                    l.appendChild(e);
                });
                const b=document.getElementById("notif-badge"); if(u>0){b.style.display="flex";b.innerText=u}else{b.style.display="none"}
            });
        }
        async function createNotification(t,y,pid) { if(t===currentUser.uid)return; let txt="interacted."; if(y==='like')txt="liked your post."; if(y==='comment')txt="commented."; if(y==='share')txt="shared your post."; if(y==='friend_req')txt="sent a friend request."; await addDoc(collection(db,"notifications"),{recipient:t,sender:currentUserName,senderUid:currentUser.uid,type:y,text:txt,postId:pid,read:false,time:serverTimestamp()}); }

        // --- ACTIONS ---
        window.likePost = async (id,oid) => { const r=doc(db,"posts",id); const d=await getDoc(r); if(d.exists()){const p=d.data();const u=currentUser.uid;let l=p.likes||[];let c=p.likes.includes(u); if(c){ updateDoc(r,{likes:arrayRemove(u)}); } else { updateDoc(r,{likes:arrayUnion(u)}); createNotification(oid,'like',id); } } };
        window.sharePost = async (id,u,oid) => { updateDoc(doc(db,"posts",id),{shareCount:increment(1)}); createNotification(oid,'share',id); const d={title:`Post by ${u}`,text:"Check this out!",url:location.href}; if(navigator.share)navigator.share(d); else alert("Link copied!"); };
        window.sendComment = async (id,oid) => { const i=document.getElementById(`input-${id}`); const t=i.value.trim(); if(!t)return; await addDoc(collection(db,"posts",id,"comments"),{text:t,user:currentUserName,uid:currentUser.uid}); i.value=""; createNotification(oid,'comment',id); };

        window.toggleFriend = async (targetUid) => {
            const btn = document.getElementById("friend-user-btn");
            const myRef = doc(db, "users", currentUser.uid);
            const targetRef = doc(db, "users", targetUid);
            const state = btn.innerText;
            if (state === "Add Friend") {
                await updateDoc(myRef, { requestsSent: arrayUnion(targetUid) });
                await updateDoc(targetRef, { requestsReceived: arrayUnion(currentUser.uid) });
                createNotification(targetUid, 'friend_req', null);
            } else if (state === "Request Sent") {
                await updateDoc(myRef, { requestsSent: arrayRemove(targetUid) });
                await updateDoc(targetRef, { requestsReceived: arrayRemove(currentUser.uid) });
            } else if (state === "Accept Request") {
                await updateDoc(myRef, { friends: arrayUnion(targetUid), requestsReceived: arrayRemove(targetUid) });
                await updateDoc(targetRef, { friends: arrayUnion(currentUser.uid), requestsSent: arrayRemove(currentUser.uid) });
                createNotification(targetUid, 'friend_accept', null);
            } else if (state === "Friends") {
                if(!confirm("Unfriend this user?")) return;
                await updateDoc(myRef, { friends: arrayRemove(targetUid) });
                await updateDoc(targetRef, { friends: arrayRemove(currentUser.uid) });
            }
        }

        // --- FEED & NAV ---
        function loadFeed() { 
            onSnapshot(query(postsRef, orderBy("createdAt", "desc")), (sn) => { 
                const f = document.getElementById("feed"); f.innerHTML = ""; 
                sn.forEach(ds => { 
                    const x = ds.data(); const id = ds.id; 
                    const liked = x.likes && x.likes.includes(currentUser.uid);
                    const isMe = x.uid === currentUser.uid;
                    // IF IT'S ME, USE GLOBAL NAME, ELSE USE POST NAME
                    const dName = isMe ? currentUserName : (x.name || "User");
                    
                    const el = document.createElement("div"); el.className = "post";
                    el.innerHTML = `
                    <div class="user-header">
                        <div class="avatar" style="background-image:url('${x.userPic||""}')" onclick="openUserProfile('${x.uid}')"></div>
                        <div class="user-meta"><h4 onclick="openUserProfile('${x.uid}')">${dName}</h4><span>${x.createdAt ? new Date(x.createdAt.seconds*1000).toLocaleDateString() : 'Just now'}</span></div>
                        ${isMe ? `<div style="margin-left:auto;color:#555;font-size:12px;cursor:pointer;" onclick="openEditMode('${id}','${escape(x.text)}')">Edit</div><div style="margin-left:10px;color:#f00;font-size:12px;cursor:pointer;" onclick="delPost('${id}')">Del</div>` : ''}
                    </div>
                    <div class="content">${x.text}</div>
                    ${x.imageUrl ? `<img src="${x.imageUrl}" class="post-img">` : ""}
                    <div class="actions">
                        <button class="act-btn ${liked?'liked':''}" onclick="likePost('${id}','${x.uid}')"><svg class="icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg> ${x.likes?x.likes.length:0}</button>
                        <button class="act-btn" onclick="toggleComments('${id}')"><svg class="icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg> Comment</button>
                        <button class="act-btn" onclick="sharePost('${id}','${x.name}','${x.uid}')"><svg class="icon" viewBox="0 0 24 24"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> ${x.shareCount||0}</button>
                    </div>
                    <div id="comments-${id}" class="comments-section">
                        <div class="comment-input-row"><input id="input-${id}" class="mini-input" placeholder="Add a comment..."><button onclick="sendComment('${id}','${x.uid}')" class="mini-btn">Post</button></div>
                        <div id="comment-list-${id}" style="margin-top:10px;"></div>
                    </div>`;
                    f.appendChild(el);
                    
                    // LOAD COMMENTS FOR THIS POST
                    onSnapshot(collection(db,"posts",id,"comments"), csn => {
                        const cl = document.getElementById(`comment-list-${id}`); cl.innerHTML="";
                        csn.forEach(c => { const cd=c.data(); cl.innerHTML+=`<div class="single-comment"><span class="c-user">${cd.user}</span>${cd.text}</div>`; });
                    });
                }); 
            }); 
        }

        window.openEditMode = (id,t) => { currentEditPostId=id; document.getElementById('edit-overlay').classList.remove('hidden'); document.getElementById('edit-text-input').value=unescape(t); };
        window.closeEditMode = () => document.getElementById('edit-overlay').classList.add('hidden');
        window.saveEditedPost = async () => { if(!currentEditPostId)return; const t=document.getElementById('edit-text-input').value; await updateDoc(doc(db,"posts",currentEditPostId),{text:t}); window.closeEditMode(); };
        window.switchTab = (t) => { if(t!=='user-view') previousTab=t; document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('nav-active')); if(t==='home')document.querySelectorAll('.nav-item')[0].classList.add('nav-active'); if(t==='chats')document.querySelectorAll('.nav-item')[1].classList.add('nav-active'); if(t==='search')document.querySelectorAll('.nav-item')[2].classList.add('nav-active'); if(t==='notifs')document.querySelectorAll('.nav-item')[3].classList.add('nav-active'); if(t==='profile')document.querySelectorAll('.nav-item')[4].classList.add('nav-active'); };
        
        window.openUserProfile = async (uid) => {
            if(!uid) return;
            window.switchTab('user-view');
            // Reset UI
            document.getElementById("view-name").innerText = "Loading..."; document.getElementById("view-nick").innerText = ""; document.getElementById("view-bio").innerText = ""; document.getElementById("view-pic").style.backgroundImage = "none"; document.getElementById("view-cover").style.backgroundImage = "none";
            document.getElementById("friend-user-btn").className = "friend-btn add"; document.getElementById("friend-user-btn").innerText = "Add Friend";
            
            // Buttons logic
            document.getElementById("message-user-btn").onclick=()=>startChat(uid);
            document.getElementById("friend-user-btn").onclick=()=>toggleFriend(uid);
            
            // Listener for Friend Status
            if(friendListener) friendListener();
            friendListener = onSnapshot(doc(db,"users",currentUser.uid), (doc) => {
                if(doc.exists()) {
                    const me = doc.data();
                    const btn = document.getElementById("friend-user-btn");
                    if(me.friends && me.friends.includes(uid)) { btn.innerText = "Friends"; btn.className = "friend-btn friends"; }
                    else if(me.requestsSent && me.requestsSent.includes(uid)) { btn.innerText = "Request Sent"; btn.className = "friend-btn requested"; }
                    else if(me.requestsReceived && me.requestsReceived.includes(uid)) { btn.innerText = "Accept Request"; btn.className = "friend-btn accept"; }
                    else { btn.innerText = "Add Friend"; btn.className = "friend-btn add"; }
                }
            });

            // Load Data
            try {
                const d=await getDoc(doc(db,"users",uid));
                if(d.exists()){
                    const u=d.data();
                    document.getElementById("view-name").innerText = u.name || "Anonymous";
                    document.getElementById("view-nick").innerText = u.nickname || "@unknown";
                    document.getElementById("view-bio").innerText = u.bio || "No bio available.";
                    document.getElementById("view-country").innerText = u.country ? "üìç " + u.country : "üìç Earth";
                    if(u.pic) document.getElementById("view-pic").style.backgroundImage = `url('${u.pic}')`;
                    if(u.coverPic) document.getElementById("view-cover").style.backgroundImage = `url('${u.coverPic}')`;
                    if(u.themeColor) applyUserViewTheme(u.themeColor); else applyUserViewTheme("#bf00ff");
                } else { document.getElementById("view-name").innerText = "User Not Found"; }
            } catch(e) { console.log(e); document.getElementById("view-name").innerText = "Error Loading Profile"; }

            // Load User Posts
            const q=query(postsRef, orderBy("createdAt","desc"));
            const s=await getDocs(q);
            const p=document.getElementById("user-posts-feed"); p.innerHTML="";
            s.forEach(d=>{ const x=d.data(); if(x.uid===uid){ const e=document.createElement("div"); e.className="post"; e.innerHTML=`<div class="content">${x.text}</div>${x.imageUrl?`<img src="${x.imageUrl}" class="post-img">`:''}`; p.appendChild(e); } });
        };

        window.goBack = () => window.switchTab('home');
        window.delPost = (id) => { if(confirm("Delete?")) deleteDoc(doc(db,"posts",id)); };
        window.toggleComments = (id) => { const s=document.getElementById(`comments-${id}`); const h=s.style.display==="none"||s.style.display===""; if(h)s.style.display="block"; else s.style.display="none"; };
        document.getElementById("searchInput").addEventListener("input", async (e) => { const t=e.target.value.trim().toLowerCase(); const r=document.getElementById("searchResults"); r.innerHTML=""; if(!t)return; const q=query(collection(db,"users")); const s=await getDocs(q); s.forEach(d=>{ const u=d.data(); if((u.name&&u.name.toLowerCase().includes(t)) || (u.email&&u.email.includes(t))){ const el=document.createElement("div"); el.className="user-result"; el.innerHTML=`<div class="avatar" style="background-image:url('${u.pic||''}')"></div><div style="color:#fff;">${u.name}</div>`; el.onclick=()=>window.openUserProfile(d.id); r.appendChild(el); } }); });
        
        window.logout = () => signOut(auth);
        document.getElementById("auth-action-btn").addEventListener("click", () => { const e=document.getElementById("email").value; const p=document.getElementById("password").value; if(document.getElementById("auth-title").innerText.includes("Create")) createUserWithEmailAndPassword(auth,e,p).then(async(c)=>{ await setDoc(doc(db,"users",c.user.uid),{email:e,name:e.split('@')[0],friends:[],requestsSent:[],requestsReceived:[]}); location.reload(); }).catch(e=>alert(e.message)); else signInWithEmailAndPassword(auth,e,p).catch(e=>alert(e.message)); });
        document.getElementById("toggle-auth-btn").addEventListener("click", function() { const t=this.innerText.includes("Create"); this.innerText=t?"Have an account? Login":"New here? Create Account"; document.getElementById("auth-title").innerText=t?"Sign Up":"Login"; document.getElementById("auth-action-btn").innerText=t?"Sign Up":"Login"; });
    </script>
</body>
</html>
